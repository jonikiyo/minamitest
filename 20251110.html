<!DOCTYPE html>
<html lang="ja" data-theme="light">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<title>病院経営分析シミュレーター - 外来・入院統合版</title>
<style>
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;background:linear-gradient(135deg,#4f46e5 0%,#06b6d4 100%);margin:0;padding:20px;min-height:100vh;min-height:100svh;min-height:100dvh;-webkit-text-size-adjust:100%;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
.container{max-width:1200px;margin:0 auto;background:#fff;border-radius:20px;box-shadow:0 20px 40px rgba(0,0,0,0.1);overflow:hidden;animation:slideIn .6s ease-out}
@keyframes slideIn{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}
header{padding:30px;background:linear-gradient(135deg,#4f46e5 0%,#06b6d4 100%);color:#fff;text-align:center;position:relative;overflow:hidden}
header::before{content:'';position:absolute;top:-50%;left:-50%;width:200%;height:200%;background:url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="20" cy="20" r="2" fill="rgba(255,255,255,0.1)"/><circle cx="80" cy="40" r="1.5" fill="rgba(255,255,255,0.1)"/><circle cx="40" cy="80" r="1" fill="rgba(255,255,255,0.1)"/></svg>');animation:float 20s infinite linear}
@keyframes float{0%{transform:translate(-50%,-50%) rotate(0deg)}100%{transform:translate(-50%,-50%) rotate(360deg)}}
h1{margin:0;font-size:2rem;font-weight:700;position:relative;z-index:1}
.subtitle{margin:10px 0 0 0;font-size:1.1rem;opacity:.9;position:relative;z-index:1}
.department-selector{display:flex;gap:10px;justify-content:center;margin-top:20px}
.dept-btn{padding:10px 20px;border:2px solid rgba(255,255,255,0.5);background:rgba(255,255,255,0.1);color:#fff;border-radius:10px;font-weight:600;cursor:pointer;transition:all .3s ease;min-height:44px;font-size:1rem;touch-action:manipulation;-webkit-user-select:none;user-select:none}
.dept-btn:hover{background:rgba(255,255,255,0.2);transform:translateY(-2px)}
.dept-btn:active{transform:translateY(0)}
.dept-btn.active{background:rgba(255,255,255,0.3);border-color:#fff;box-shadow:0 4px 15px rgba(255,255,255,0.3)}
.tabs{display:flex;gap:0;background:#f8fafc;border-bottom:1px solid #e2e8f0}
.tab-button{flex:1;padding:18px 20px;border:none;background:transparent;color:#64748b;font-weight:600;cursor:pointer;transition:all .3s ease;position:relative;font-size:1rem;min-height:44px;touch-action:manipulation;-webkit-user-select:none;user-select:none}
.tab-button:hover{background:#f1f5f9;color:#475569}
.tab-button:active{background:#e2e8f0}
.tab-button.active{background:#fff;color:#4f46e5;box-shadow:0 -2px 0 #4f46e5}
.tab-button.active::after{content:'';position:absolute;bottom:0;left:0;right:0;height:3px;background:linear-gradient(90deg,#4f46e5,#06b6d4)}
.tab-button.hidden{display:none}
.tab-content{display:none;padding:30px;background:#fff;min-height:500px;animation:fadeIn .4s ease-out}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.tab-content.active{display:block}
.form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:25px;margin-bottom:30px}
.form-section{background:#f8fafc;padding:25px;border-radius:15px;border:1px solid #e2e8f0;transition:all .3s ease}
.form-section:hover{box-shadow:0 8px 25px rgba(0,0,0,0.08);transform:translateY(-2px)}
.section-title{font-size:1.2rem;font-weight:700;color:#1e293b;margin-bottom:20px;display:flex;align-items:center;gap:10px}
.form-group{margin-bottom:20px}
label{display:block;font-weight:600;color:#374151;margin-bottom:8px;font-size:.95rem}
input[type="number"],input[type="text"],select{width:100%;padding:12px 16px;border:2px solid #e5e7eb;border-radius:10px;font-size:16px;background:#fff;transition:all .3s ease;min-height:44px;-webkit-appearance:none;appearance:none}
input[type="number"]{-webkit-appearance:none;-moz-appearance:textfield;appearance:textfield}
input[type="number"]::-webkit-inner-spin-button,input[type="number"]::-webkit-outer-spin-button{-webkit-appearance:none;margin:0}
input[type="number"]:focus,input[type="text"]:focus,select:focus{outline:none;border-color:#4f46e5;box-shadow:0 0 0 3px rgba(79,70,229,0.1)}
.radio-group{display:flex;gap:20px;align-items:center;margin-bottom:15px;flex-wrap:wrap}
.radio-item{display:flex;align-items:center;gap:8px;cursor:pointer;padding:8px 12px;border-radius:8px;transition:background-color .2s ease;min-height:44px;touch-action:manipulation;-webkit-user-select:none;user-select:none}
.radio-item:hover{background:#f1f5f9}
.radio-item:active{background:#e2e8f0}
.radio-item input[type="radio"]{width:20px;height:20px;margin:0;cursor:pointer}
.radio-item label{cursor:pointer;user-select:none;margin:0}
.checkbox-group{display:flex;gap:20px;align-items:center;margin-bottom:15px;flex-wrap:wrap}
.checkbox-item{display:flex;align-items:center;gap:8px;cursor:pointer;padding:8px 12px;border-radius:8px;transition:background-color .2s ease;min-height:44px;touch-action:manipulation;-webkit-user-select:none;user-select:none}
.checkbox-item:hover{background:#f1f5f9}
.checkbox-item:active{background:#e2e8f0}
.checkbox-item input[type="checkbox"]{width:20px;height:20px;margin:0;cursor:pointer}
.checkbox-item label{cursor:pointer;user-select:none;margin:0}
.result-box{background:linear-gradient(135deg,#f8fafc 0%,#f1f5f9 100%);padding:25px;border-radius:15px;margin:20px 0;border:1px solid #e2e8f0;box-shadow:0 4px 6px rgba(0,0,0,0.05)}
.result-item{margin-bottom:12px;font-size:1.1rem;color:#1e293b;display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid #e2e8f0}
.result-item:last-child{border-bottom:none}
.result-label{font-weight:600}
.result-value{font-weight:800;color:#4f46e5;font-size:1.2rem}
.result-value.positive{color:#059669}
.result-value.negative{color:#dc2626}
.muted{color:#6b7280;font-size:.9rem}
.actions{text-align:center;margin:30px 0}
button{cursor:pointer;touch-action:manipulation;-webkit-appearance:none;appearance:none;-webkit-user-select:none;user-select:none;outline:none;border:none}
button:active{opacity:0.9}
button.primary{background:linear-gradient(135deg,#4f46e5 0%,#06b6d4 100%);color:#fff;padding:15px 30px;border-radius:12px;font-weight:700;font-size:1.1rem;transition:all .3s ease;box-shadow:0 4px 15px rgba(79,70,229,0.3);min-height:44px}
button.primary:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(79,70,229,0.4)}
button.primary:active{transform:translateY(0);opacity:0.95}
button.secondary{background:#f8fafc;color:#475569;border:2px solid #e2e8f0;padding:12px 24px;border-radius:10px;font-weight:600;margin:0 8px;transition:all .3s ease;min-height:44px}
button.secondary:hover{background:#f1f5f9;border-color:#cbd5e1}
button.secondary:active{background:#e2e8f0;opacity:0.95}
label.secondary{background:#f8fafc;color:#475569;border:2px solid #e2e8f0;padding:12px 24px;border-radius:10px;cursor:pointer;font-weight:600;margin:0 8px;transition:all .3s ease;min-height:44px;touch-action:manipulation;display:inline-flex;align-items:center;justify-content:center;-webkit-user-select:none;user-select:none}
label.secondary:hover{background:#f1f5f9;border-color:#cbd5e1}
label.secondary:active{background:#e2e8f0;opacity:0.95}
footer{padding:20px 30px;text-align:center;font-size:.9rem;color:#6b7280;background:#f8fafc;border-top:1px solid #e2e8f0}
.scenario-manager{background:#fff;padding:25px;border-radius:15px;margin-bottom:25px;border:1px solid #e2e8f0;box-shadow:0 2px 4px rgba(0,0,0,0.05)}
.scenario-buttons{display:flex;gap:10px;flex-wrap:wrap;margin-top:15px}
.sensitivity-controls{background:#f8fafc;padding:20px;border-radius:12px;margin:20px 0 0 0}
.slider-group{margin:15px 0}
.slider-label{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
input[type="range"]{width:100%;height:6px;border-radius:3px;background:#e2e8f0;outline:none;-webkit-appearance:none;appearance:none;cursor:pointer}
input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;width:24px;height:24px;border-radius:50%;background:#4f46e5;cursor:pointer;box-shadow:0 2px 4px rgba(0,0,0,0.2)}
input[type="range"]::-moz-range-thumb{width:24px;height:24px;border-radius:50%;background:#4f46e5;cursor:pointer;border:none;box-shadow:0 2px 4px rgba(0,0,0,0.2)}
.alert{padding:15px 20px;border-radius:10px;margin:15px 0;font-weight:600;animation:slideDown 0.3s ease-out}
@keyframes slideDown{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
.alert.success{background:#d1fae5;color:#065f46;border:1px solid #a7f3d0}
.alert.warning{background:#fef3c7;color:#92400e;border:1px solid #fde68a}
.alert.error{background:#fee2e2;color:#991b1b;border:1px solid #fecaca}
.kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin:20px 0}
.kpi-card{background:linear-gradient(135deg,#4f46e5 0%,#06b6d4 100%);color:#fff;padding:20px;border-radius:15px;text-align:center;box-shadow:0 4px 15px rgba(79,70,229,0.3)}
.kpi-value{font-size:2rem;font-weight:800;margin-bottom:5px}
.kpi-label{font-size:.9rem;opacity:.9}
.benchmark-section{background:#fff3cd;border:1px solid #ffeaa7;border-radius:10px;padding:20px;margin:20px 0}
.benchmark-title{font-weight:700;color:#856404;margin-bottom:15px}
.benchmark-item{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #ffeaa7}
.benchmark-item:last-child{border-bottom:none}
.sensitivity-btn{width:44px;height:44px;border:2px solid #4f46e5;background:#fff;color:#4f46e5;border-radius:8px;font-size:18px;font-weight:bold;cursor:pointer;transition:all .2s ease;display:flex;align-items:center;justify-content:center;touch-action:manipulation;-webkit-user-select:none;user-select:none;flex-shrink:0}
.sensitivity-btn:hover{background:#4f46e5;color:#fff;transform:translateY(-1px)}
.sensitivity-btn:active{transform:translateY(0);box-shadow:0 2px 4px rgba(79,70,229,0.3);opacity:0.95}
.outpatient-specific{background:linear-gradient(135deg,#e0f2fe 0%,#f0f9ff 100%);border:2px solid #0ea5e9}
.inpatient-specific{background:linear-gradient(135deg,#fce7f3 0%,#fdf2f8 100%);border:2px solid #ec4899}
table{font-size:.9rem;-webkit-touch-callout:none;-webkit-user-select:none;user-select:text}
table th{white-space:nowrap}
table td{white-space:nowrap}
table th:first-child,table td:first-child{position:sticky;left:0;z-index:1;will-change:transform;-webkit-transform:translateZ(0);transform:translateZ(0)}
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.4);display:none;align-items:center;justify-content:center;z-index:2000;padding:20px;touch-action:none}
.modal{background:#fff;border-radius:12px;width:100%;max-width:560px;box-shadow:0 10px 30px rgba(0,0,0,0.15);border:1px solid #e2e8f0;overflow:hidden;animation:fadeIn .2s ease-out}
.modal-header{padding:16px 20px;background:#f8fafc;border-bottom:1px solid #e2e8f0;display:flex;align-items:center;justify-content:space-between}
.modal-title{font-weight:700;color:#1e293b}
.modal-body{padding:16px 20px;max-height:60vh;overflow-y:auto;-webkit-overflow-scrolling:touch;overscroll-behavior:contain}
.modal-footer{padding:16px 20px;background:#f8fafc;border-top:1px solid #e2e8f0;display:flex;gap:10px;justify-content:flex-end}
.modal-close{border:none;background:transparent;color:#64748b;font-size:24px;line-height:1;cursor:pointer;padding:8px;min-width:44px;min-height:44px;display:flex;align-items:center;justify-content:center;touch-action:manipulation;-webkit-user-select:none;user-select:none}
.picker-item{display:flex;align-items:center;gap:10px;padding:12px 8px;border-radius:8px;cursor:pointer;touch-action:manipulation;-webkit-user-select:none;user-select:none}
.picker-item:hover{background:#f1f5f9}
.picker-item:active{background:#e2e8f0}
.picker-item input[type="radio"]{width:20px;height:20px;margin:0;cursor:pointer}
.month-select-item{padding:12px;border-radius:8px;cursor:pointer;transition:background-color .2s ease}
.month-select-item:hover{background:#f1f5f9}
.privacy-notice{background:#fef3c7;border:1px solid #fde68a;border-radius:8px;padding:12px;margin:15px 0;font-size:0.9rem;color:#92400e;display:none}
.privacy-notice.show{display:block}
@media (max-width:768px){
.container{margin:10px;border-radius:15px}
.form-grid{grid-template-columns:1fr;gap:20px}
.tabs{flex-direction:column}
.tab-button{padding:15px;width:100%}
.radio-group{flex-direction:column;align-items:flex-start;gap:10px}
.checkbox-group{flex-direction:column;align-items:flex-start;gap:10px}
.scenario-buttons{flex-direction:column}
.scenario-buttons button,.scenario-buttons label{width:100%;margin:4px 0}
.kpi-grid{grid-template-columns:1fr}
h1{font-size:1.5rem}
table{font-size:.75rem}
table th,table td{padding:6px!important;min-width:80px}
#op-sensitivity-tab>div:first-child,#ip-sensitivity-tab>div:first-child{grid-template-columns:1fr!important}
.department-selector{flex-direction:column;width:100%}
.dept-btn{width:100%}
.actions button{display:block;width:100%;margin:8px 0}
.modal{max-height:90vh}
input[type="number"],input[type="text"],select{font-size:16px!important}
}
</style>
</head>
<body>
<div class="container">
<header>
<h1>🏥 病院経営分析シミュレーター</h1>
<div class="department-selector">
<button class="dept-btn active" data-dept="outpatient">🚶 外来部門</button>
<button class="dept-btn" data-dept="inpatient">🛏️ 入院部門</button>
</div>
</header>
<div id="privacy-notice" class="privacy-notice">
⚠️ プライベートブラウジングモードでは、データは保存されません。通常モードでのご利用を推奨します。
</div>
<div id="outpatient-section">
<div class="tabs">
<button class="tab-button active" data-tab="op-input">📊 データ入力</button>
<button class="tab-button" data-tab="op-results">📈 分析結果</button>
<button class="tab-button" data-tab="op-sensitivity">🔍 収益影響シミュレーション</button>
<button class="tab-button" data-tab="op-scenarios">💡 月次データ管理</button>
<button class="tab-button" data-tab="op-benchmark">🎯 目標達成分析</button>
<button class="tab-button" data-tab="op-department">🏥 診療科別</button>
</div>

<div id="op-input-tab" class="tab-content active">
<div class="actions" style="text-align:left;margin-top:0;margin-bottom:20px">
<button class="secondary" data-action="loadAverage" data-dept="outpatient">📊 保存データから平均値を取得</button>
<button class="secondary" data-action="openPicker" data-dept="outpatient">📂 保存データから月次データを取得</button>
</div>
<div class="form-grid">
<div class="form-section">
<div class="section-title">💰 収益・費用データ</div>
<div class="form-group">
<label>保険診療売上入力方法</label>
<div class="radio-group">
<div class="radio-item">
<input type="radio" name="op-insuranceMode" value="total" id="op-insuranceModeTotal" checked data-dept="outpatient">
<label for="op-insuranceModeTotal">総売上（円/月）</label>
</div>
<div class="radio-item">
<input type="radio" name="op-insuranceMode" value="unit" id="op-insuranceModeUnit" data-dept="outpatient">
<label for="op-insuranceModeUnit">平均単価（円/人）</label>
</div>
</div>
<input type="number" id="op-insuranceRevenue" placeholder="総売上または単価を入力" inputmode="numeric" pattern="[0-9]*" data-realtime="true" data-dept="outpatient">
</div>
<div class="form-group">
<label>保険外売上（円/月）</label>
<input type="number" id="op-nonInsuranceRevenue" placeholder="例: 5000000" inputmode="numeric" pattern="[0-9]*" data-realtime="true" data-dept="outpatient">
</div>
<div class="form-group">
<label>過誤、その他（円/月）</label>
<input type="number" id="op-otherRevenue" placeholder="例: 1000000" inputmode="numeric" pattern="[0-9]*" data-realtime="true" data-dept="outpatient">
</div>
<div class="form-group">
<label>変動費入力方法</label>
<div class="radio-group">
<div class="radio-item">
<input type="radio" name="op-varMode" value="amount" id="op-varModeAmount" checked data-dept="outpatient">
<label for="op-varModeAmount">金額で入力</label>
</div>
<div class="radio-item">
<input type="radio" name="op-varMode" value="rate" id="op-varModeRate" data-dept="outpatient">
<label for="op-varModeRate">変動費率で入力（%）</label>
</div>
</div>
<input type="number" id="op-variableCost" placeholder="金額または率（%）を入力" inputmode="decimal" data-realtime="true" data-dept="outpatient">
<div class="checkbox-group" style="margin-top:10px">
<div class="checkbox-item">
<input type="checkbox" id="op-varTargetInsurance" checked data-dept="outpatient">
<label for="op-varTargetInsurance">保険診療を対象</label>
</div>
<div class="checkbox-item">
<input type="checkbox" id="op-varTargetNonInsurance" data-dept="outpatient">
<label for="op-varTargetNonInsurance">保険外診療を対象</label>
</div>
<div class="checkbox-item">
<input type="checkbox" id="op-varTargetOther" data-dept="outpatient">
<label for="op-varTargetOther">過誤その他を対象</label>
</div>
</div>
</div>
<div class="form-group">
<label>固定費（円/月）</label>
<input type="number" id="op-fixedCost" placeholder="例: 150000000" inputmode="numeric" pattern="[0-9]*" data-realtime="true" data-dept="outpatient">
</div>
</div>
<div class="form-section outpatient-specific">
<div class="section-title">👥 外来患者データ</div>
<div class="form-group">
<label>診療日数（日/月）</label>
<select id="op-clinicDays" data-dept="outpatient">
<option value="1">1日</option><option value="2">2日</option><option value="3">3日</option><option value="4">4日</option><option value="5">5日</option><option value="6">6日</option><option value="7">7日</option><option value="8">8日</option><option value="9">9日</option><option value="10">10日</option><option value="11">11日</option><option value="12">12日</option><option value="13">13日</option><option value="14">14日</option><option value="15">15日</option><option value="16">16日</option><option value="17">17日</option><option value="18">18日</option><option value="19">19日</option><option value="20">20日</option><option value="21">21日</option><option value="22" selected>22日</option><option value="23">23日</option><option value="24">24日</option><option value="25">25日</option><option value="26">26日</option><option value="27">27日</option><option value="28">28日</option><option value="29">29日</option><option value="30">30日</option><option value="31">31日</option><option value="custom">カスタム</option>
</select>
<input type="number" id="op-customClinicDays" placeholder="カスタム日数" style="display:none;margin-top:10px" inputmode="numeric" pattern="[0-9]*" data-realtime="true" data-dept="outpatient">
</div>
<div class="form-group">
<label>患者数入力方法</label>
<div class="radio-group">
<div class="radio-item">
<input type="radio" name="op-patientMode" value="daily" id="op-patientModeDaily" checked data-dept="outpatient">
<label for="op-patientModeDaily">1日平均患者数（人）</label>
</div>
</div>
<input type="number" id="op-dailyPatients" placeholder="例: 120" inputmode="numeric" pattern="[0-9]*" data-realtime="true" data-dept="outpatient">
<div class="radio-group" style="margin-top:10px">
<div class="radio-item">
<input type="radio" name="op-patientMode" value="monthly" id="op-patientModeMonthly" data-dept="outpatient">
<label for="op-patientModeMonthly">月間総患者数（人）</label>
</div>
</div>
<input type="number" id="op-monthlyPatients" placeholder="例: 2400" inputmode="numeric" pattern="[0-9]*" data-realtime="true" data-dept="outpatient">
</div>
</div>
</div>
<div id="op-realtimeResults" class="result-box" style="display:none">
<div class="section-title">📊 リアルタイム計算結果</div>
<div id="op-realtimeContent"></div>
</div>
<div class="form-section">
<div class="section-title">🧮 詳細分析オプション</div>
<div class="form-group">
<label>保険外診療の扱い</label>
<div class="radio-group">
<div class="radio-item">
<input type="radio" name="op-analysisMode" value="include" id="op-analysisModeInclude" checked data-dept="outpatient">
<label for="op-analysisModeInclude">保険外を計算に含める</label>
</div>
<div class="radio-item">
<input type="radio" name="op-analysisMode" value="exclude" id="op-analysisModeExclude" data-dept="outpatient">
<label for="op-analysisModeExclude">保険外を計算に含めない</label>
</div>
</div>
<p class="muted" style="margin-top:10px;font-size:0.85rem">
※「保険外を計算に含めない」を選択した場合、変動費も自動的に保険診療のみを対象として計算されます
</p>
</div>
<div class="form-group">
<label>過誤その他の扱い</label>
<div class="radio-group">
<div class="radio-item">
<input type="radio" name="op-otherMode" value="include" id="op-otherModeInclude" checked data-dept="outpatient">
<label for="op-otherModeInclude">過誤その他を計算に含める</label>
</div>
<div class="radio-item">
<input type="radio" name="op-otherMode" value="exclude" id="op-otherModeExclude" data-dept="outpatient">
<label for="op-otherModeExclude">過誤その他を計算に含めない</label>
</div>
</div>
</div>
</div>
<div class="actions">
<button class="primary" data-action="calculate" data-dept="outpatient">🧮 詳細分析を実行</button>
</div>
</div>
<div id="op-results-tab" class="tab-content">
<div class="kpi-grid" id="op-kpiGrid" style="display:none"></div>
<div class="form-section" id="op-targetSection">
<div class="section-title">🎯 目標設定</div>
<div class="form-group">
<label>目標損益分岐点比率（％）</label>
<input type="number" id="op-targetRate" placeholder="例: 95" value="100" inputmode="decimal" data-update="results" data-dept="outpatient">
</div>
<div class="form-group">
<label>目標経常利益（円）</label>
<input type="number" id="op-targetProfit" placeholder="例: 20000000" inputmode="numeric" pattern="[0-9]*" data-update="target" data-dept="outpatient">
</div>
<div class="form-group">
<label>目標1日患者数（人）</label>
<input type="number" id="op-targetDailyPatients" placeholder="例: 150" inputmode="numeric" pattern="[0-9]*" data-update="patient" data-dept="outpatient">
</div>
<div class="actions">
<button class="primary" data-action="updateResults" data-dept="outpatient">📊 結果を更新</button>
<button class="secondary" data-action="exportCSV" data-dept="outpatient">📊 CSVエクスポート</button>
<button class="secondary" data-action="print">🖨️ 印刷</button>
</div>
</div>
<div id="op-results" class="result-box">
<div class="muted">計算結果がここに表示されます。まずデータ入力タブで必要な情報を入力してください。</div>
</div>
<div id="op-targetAnalysisResults" class="result-box" style="display:none">
<div class="section-title">🎯 目標達成分析</div>
<div id="op-targetAnalysisContent"></div>
</div>
<div id="op-patientAnalysisResults" class="result-box" style="display:none">
<div class="section-title">👥 患者数目標分析</div>
<div id="op-patientAnalysisContent"></div>
</div>
</div>

<div id="op-sensitivity-tab" class="tab-content">
<div style="display:grid;grid-template-columns:1fr 1fr;gap:25px;align-items:start">
<div class="form-section">
<div class="section-title">🔍 収益影響シミュレーション</div>
<p class="muted">各パラメータを変動させて、経常利益への影響を確認できます。</p>
<p class="muted" style="color:#dc2626;font-weight:600">※保険外診療収益と過誤その他は変動させず、固定値として扱います</p>
<div class="sensitivity-controls">
<div class="slider-group">
<div class="slider-label">
<span>平均診療単価変動</span>
<span id="op-priceVariation">±0円</span>
</div>
<div style="display:flex;align-items:center;gap:10px;margin-bottom:10px">
<button type="button" class="sensitivity-btn" data-adjust="price" data-dept="outpatient" data-delta="-100">－</button>
<input type="range" id="op-priceSlider" min="-3000" max="3000" step="100" value="0" data-sensitivity="true" data-dept="outpatient" style="flex:1">
<button type="button" class="sensitivity-btn" data-adjust="price" data-dept="outpatient" data-delta="100">＋</button>
</div>
</div>
<div class="slider-group">
<div class="slider-label">
<span>1日患者数変動</span>
<span id="op-patientVariation">±0人</span>
</div>
<div style="display:flex;align-items:center;gap:10px;margin-bottom:10px">
<button type="button" class="sensitivity-btn" data-adjust="patient" data-dept="outpatient" data-delta="-1">－</button>
<input type="range" id="op-patientSlider" min="-50" max="50" step="1" value="0" data-sensitivity="true" data-dept="outpatient" style="flex:1">
<button type="button" class="sensitivity-btn" data-adjust="patient" data-dept="outpatient" data-delta="1">＋</button>
</div>
</div>
<div class="slider-group">
<div class="slider-label">
<span>変動費変動率</span>
<span id="op-variableVariation">±0%</span>
</div>
<div style="display:flex;align-items:center;gap:10px;margin-bottom:10px">
<button type="button" class="sensitivity-btn" data-adjust="variable" data-dept="outpatient" data-delta="-1">－</button>
<input type="range" id="op-variableSlider" min="-30" max="30" value="0" data-sensitivity="true" data-dept="outpatient" style="flex:1">
<button type="button" class="sensitivity-btn" data-adjust="variable" data-dept="outpatient" data-delta="1">＋</button>
</div>
</div>
<div class="slider-group">
<div class="slider-label">
<span>固定費変動率</span>
<span id="op-fixedVariation">±0%</span>
</div>
<div style="display:flex;align-items:center;gap:10px;margin-bottom:10px">
<button type="button" class="sensitivity-btn" data-adjust="fixed" data-dept="outpatient" data-delta="-1">－</button>
<input type="range" id="op-fixedSlider" min="-30" max="30" value="0" data-sensitivity="true" data-dept="outpatient" style="flex:1">
<button type="button" class="sensitivity-btn" data-adjust="fixed" data-dept="outpatient" data-delta="1">＋</button>
</div>
</div>
</div>
</div>
<div id="op-sensitivityResults" class="result-box">
<div class="section-title">📊 収益影響シミュレーション結果</div>
<div id="op-sensitivityContent">
<div class="muted">まずデータ入力タブで基本データを入力し、詳細分析を実行してください。</div>
</div>
</div>
</div>
</div>

<div id="op-scenarios-tab" class="tab-content">
<div class="scenario-manager">
<div class="section-title">💡 月次データ管理</div>
<p class="muted">最大12ヶ月分の経営データを保存・比較できます。</p>
<div class="form-grid" style="grid-template-columns:1fr 1fr;gap:15px">
<div class="form-group">
<label>月度選択</label>
<select id="op-monthSelect">
<option value="4">4月</option><option value="5">5月</option><option value="6">6月</option><option value="7">7月</option><option value="8">8月</option><option value="9">9月</option><option value="10">10月</option><option value="11">11月</option><option value="12">12月</option><option value="1">1月</option><option value="2">2月</option><option value="3">3月</option>
</select>
</div>
<div class="form-group">
<label>年度</label>
<select id="op-yearSelect">
<option value="2024">2024年度</option><option value="2025" selected>2025年度</option><option value="2026">2026年度</option>
</select>
</div>
</div>
<div class="scenario-buttons">
<button class="primary" data-action="saveMonthly" data-dept="outpatient">💾 当月データを保存</button>
<button class="secondary" data-action="loadMonthly" data-dept="outpatient">📂 当月データを読み込み</button>
<button class="secondary" data-action="deleteMonthly" data-dept="outpatient">🗑️ 当月データを削除</button>
<button class="secondary" data-action="exportMonthly" data-dept="outpatient">📤 全データをエクスポート</button>
<label for="op-importFile" class="secondary">📥 データをインポート</label>
<input type="file" id="op-importFile" accept="application/json,.json" data-import="true" data-dept="outpatient" style="position:absolute;left:-9999px;width:1px;height:1px;opacity:0">
<button class="secondary" data-action="clearMonthly" data-dept="outpatient" style="background:#fee2e2;color:#991b1b;border-color:#fecaca">🗑️ 全データクリア</button>
</div>
</div>
<div id="op-monthlyDataList" class="result-box">
<div class="section-title">📋 保存済み月次データ一覧</div>
<div id="op-monthlyDataContent">
<div class="muted">保存されたデータがここに表示されます。</div>
</div>
</div>
<div class="result-box">
<div class="section-title">📊 月次比較表</div>
<div id="op-comparisonTable" style="overflow-x:auto;-webkit-overflow-scrolling:touch">
<div class="muted">2ヶ月以上のデータが保存されると比較表が表示されます。</div>
</div>
</div>
</div>

<div id="op-benchmark-tab" class="tab-content">
<div style="background:#fff;padding:25px;border-radius:15px;margin-bottom:25px;border:1px solid #e2e8f0">
<div class="section-title">🎯 損益分岐点比率 目標達成分析</div>
<p class="muted">損益分岐点比率100%（損益ゼロ）、95%（余裕あり）、任意設定（カスタム）の3パターンで、目標達成に必要な患者数・単価を算出します。</p>
<div class="form-group" style="max-width:300px;margin:20px 0">
<label>カスタム損益分岐点比率（%）</label>
<input type="number" id="op-customBenchmarkRate" placeholder="例: 90" value="105" step="1" inputmode="decimal" data-update="benchmark" data-dept="outpatient">
<p class="muted" style="margin-top:5px;font-size:0.85rem">デフォルト: 105%（ギリギリ赤字）</p>
</div>
<div id="op-benchmarkContent">
<div class="muted">まずデータ入力タブで基本データを入力し、詳細分析を実行してください。</div>
</div>
</div>
</div>

<div id="op-department-tab" class="tab-content">
<div class="form-section">
<div class="section-title">🏥 診療科別シミュレーション</div>
<p class="muted">診療科別に必要な患者数を算出します。</p>
<div class="form-grid">
<div class="form-section">
<div class="section-title">👩‍⚕️ 診療科情報</div>
<div class="form-group">
<label>診療科名</label>
<select id="op-deptName" data-dept="outpatient">
<option value="内科">内科</option><option value="外科">外科</option><option value="耳鼻科">耳鼻科</option><option value="整形外科">整形外科</option><option value="リハビリ科">リハビリ科</option><option value="小児科">小児科</option><option value="眼科">眼科</option><option value="神経内科">神経内科</option><option value="皮膚科">皮膚科</option><option value="楽生苑">楽生苑</option><option value="特定健診">特定健診</option><option value="カスタム">カスタム</option>
</select>
<input type="text" id="op-customDeptName" placeholder="診療科名を入力" style="display:none;margin-top:10px">
</div>
<div class="form-group">
<label>診療時間（時間/日）</label>
<input type="number" id="op-deptHours" placeholder="例: 8" step="0.5" inputmode="decimal" data-deptcalc="true" data-dept="outpatient">
</div>
<div class="form-group">
<label>平均単価（円/人）</label>
<input type="number" id="op-deptPrice" placeholder="例: 8000" inputmode="numeric" pattern="[0-9]*" data-deptcalc="true" data-dept="outpatient">
</div>
</div>
<div class="form-section">
<div class="section-title">💰 コスト情報</div>
<div class="form-group">
<label>1時間あたり変動費入力方法</label>
<div class="radio-group">
<div class="radio-item">
<input type="radio" name="op-deptVarMode" value="amount" id="op-deptVarModeAmount" checked data-deptcalc="true" data-dept="outpatient">
<label for="op-deptVarModeAmount">金額で入力</label>
</div>
<div class="radio-item">
<input type="radio" name="op-deptVarMode" value="rate" id="op-deptVarModeRate" data-deptcalc="true" data-dept="outpatient">
<label for="op-deptVarModeRate">変動費率で入力（%）</label>
</div>
</div>
<input type="number" id="op-deptVariableCost" placeholder="金額または率（%）を入力" inputmode="decimal" data-deptcalc="true" data-dept="outpatient">
</div>
<div class="form-group">
<label>1時間あたり固定費（医師給与除く）（円）</label>
<input type="number" id="op-deptFixedCost" placeholder="例: 5000" inputmode="numeric" pattern="[0-9]*" data-deptcalc="true" data-dept="outpatient">
</div>
<div class="form-group">
<label>1時間あたり医師給与（円）</label>
<input type="number" id="op-deptDoctorCost" placeholder="例: 8000" inputmode="numeric" pattern="[0-9]*" data-deptcalc="true" data-dept="outpatient">
</div>
</div>
</div>
<div class="actions">
<button class="primary" data-action="calculateDept" data-dept="outpatient">📈 診療科別分析を実行</button>
</div>
</div>
<div id="op-departmentResults" class="result-box" style="display:none">
<div class="section-title">📊 診療科別分析結果</div>
<div id="op-departmentContent"></div>
</div>
</div>
</div>
<div id="inpatient-section" style="display:none">
<div class="tabs">
<button class="tab-button active" data-tab="ip-input">📊 データ入力</button>
<button class="tab-button" data-tab="ip-results">📈 分析結果</button>
<button class="tab-button" data-tab="ip-sensitivity">🔍 収益影響シミュレーション</button>
<button class="tab-button" data-tab="ip-scenarios">💡 月次データ管理</button>
<button class="tab-button" data-tab="ip-benchmark">🎯 目標達成分析</button>
</div>

<div id="ip-input-tab" class="tab-content active">
<div class="actions" style="text-align:left;margin-top:0;margin-bottom:20px">
<button class="secondary" data-action="loadAverage" data-dept="inpatient">📊 保存データから平均値を取得</button>
<button class="secondary" data-action="openPicker" data-dept="inpatient">📂 保存データから月次データを取得</button>
</div>
<div class="form-grid">
<div class="form-section">
<div class="section-title">💰 収益・費用データ</div>
<div class="form-group">
<label>保険診療売上入力方法</label>
<div class="radio-group">
<div class="radio-item">
<input type="radio" name="ip-insuranceMode" value="total" id="ip-insuranceModeTotal" checked data-dept="inpatient">
<label for="ip-insuranceModeTotal">総売上（円/月）</label>
</div>
<div class="radio-item">
<input type="radio" name="ip-insuranceMode" value="unit" id="ip-insuranceModeUnit" data-dept="inpatient">
<label for="ip-insuranceModeUnit">平均単価（円/人）</label>
</div>
</div>
<input type="number" id="ip-insuranceRevenue" placeholder="総売上または単価を入力" inputmode="numeric" pattern="[0-9]*" data-realtime="true" data-dept="inpatient">
</div>
<div class="form-group">
<label>保険外売上（円/月）</label>
<input type="number" id="ip-nonInsuranceRevenue" placeholder="例: 2000000" inputmode="numeric" pattern="[0-9]*" data-realtime="true" data-dept="inpatient">
</div>
<div class="form-group">
<label>過誤、その他（円/月）</label>
<input type="number" id="ip-otherRevenue" placeholder="例: 500000" inputmode="numeric" pattern="[0-9]*" data-realtime="true" data-dept="inpatient">
</div>
<div class="form-group">
<label>変動費入力方法</label>
<div class="radio-group">
<div class="radio-item">
<input type="radio" name="ip-varMode" value="amount" id="ip-varModeAmount" checked data-dept="inpatient">
<label for="ip-varModeAmount">金額で入力</label>
</div>
<div class="radio-item">
<input type="radio" name="ip-varMode" value="rate" id="ip-varModeRate" data-dept="inpatient">
<label for="ip-varModeRate">変動費率で入力（%）</label>
</div>
</div>
<input type="number" id="ip-variableCost" placeholder="金額または率（%）を入力" inputmode="decimal" data-realtime="true" data-dept="inpatient">
<div class="checkbox-group" style="margin-top:10px">
<div class="checkbox-item">
<input type="checkbox" id="ip-varTargetInsurance" checked data-dept="inpatient">
<label for="ip-varTargetInsurance">保険診療を対象</label>
</div>
<div class="checkbox-item">
<input type="checkbox" id="ip-varTargetNonInsurance" data-dept="inpatient">
<label for="ip-varTargetNonInsurance">保険外診療を対象</label>
</div>
<div class="checkbox-item">
<input type="checkbox" id="ip-varTargetOther" data-dept="inpatient">
<label for="ip-varTargetOther">過誤その他を対象</label>
</div>
</div>
</div>
<div class="form-group">
<label>固定費（円/月）</label>
<input type="number" id="ip-fixedCost" placeholder="例: 150000000" inputmode="numeric" pattern="[0-9]*" data-realtime="true" data-dept="inpatient">
</div>
</div>
<div class="form-section inpatient-specific">
<div class="section-title">🛏️ 入院患者データ</div>
<div class="form-group">
<label>診療日数（日/月）</label>
<select id="ip-clinicDays" data-dept="inpatient">
<option value="28">28日</option>
<option value="29">29日</option>
<option value="30">30日</option>
<option value="31" selected>31日</option>
</select>
</div>
<div class="form-group">
<label>患者数入力方法</label>
<div class="radio-group">
<div class="radio-item">
<input type="radio" name="ip-patientMode" value="daily" id="ip-patientModeDaily" checked data-dept="inpatient">
<label for="ip-patientModeDaily">1日平均患者数（人）</label>
</div>
</div>
<input type="number" id="ip-dailyPatients" placeholder="例: 60" inputmode="numeric" pattern="[0-9]*" data-realtime="true" data-dept="inpatient">
<div class="radio-group" style="margin-top:10px">
<div class="radio-item">
<input type="radio" name="ip-patientMode" value="monthly" id="ip-patientModeMonthly" data-dept="inpatient">
<label for="ip-patientModeMonthly">月間総患者数（人）</label>
</div>
</div>
<input type="number" id="ip-monthlyPatients" placeholder="例: 1800" inputmode="numeric" pattern="[0-9]*" data-realtime="true" data-dept="inpatient">
</div>
</div>
</div>
<div id="ip-realtimeResults" class="result-box" style="display:none">
<div class="section-title">📊 リアルタイム計算結果</div>
<div id="ip-realtimeContent"></div>
</div>
<div class="form-section">
<div class="section-title">🧮 詳細分析オプション</div>
<div class="form-group">
<label>保険外診療の扱い</label>
<div class="radio-group">
<div class="radio-item">
<input type="radio" name="ip-analysisMode" value="include" id="ip-analysisModeInclude" checked data-dept="inpatient">
<label for="ip-analysisModeInclude">保険外を計算に含める</label>
</div>
<div class="radio-item">
<input type="radio" name="ip-analysisMode" value="exclude" id="ip-analysisModeExclude" data-dept="inpatient">
<label for="ip-analysisModeExclude">保険外を計算に含めない</label>
</div>
</div>
<p class="muted" style="margin-top:10px;font-size:0.85rem">
※「保険外を計算に含めない」を選択した場合、変動費も自動的に保険診療のみを対象として計算されます
</p>
</div>
<div class="form-group">
<label>過誤その他の扱い</label>
<div class="radio-group">
<div class="radio-item">
<input type="radio" name="ip-otherMode" value="include" id="ip-otherModeInclude" checked data-dept="inpatient">
<label for="ip-otherModeInclude">過誤その他を計算に含める</label>
</div>
<div class="radio-item">
<input type="radio" name="ip-otherMode" value="exclude" id="ip-otherModeExclude" data-dept="inpatient">
<label for="ip-otherModeExclude">過誤その他を計算に含めない</label>
</div>
</div>
</div>
</div>
<div class="actions">
<button class="primary" data-action="calculate" data-dept="inpatient">🧮 詳細分析を実行</button>
</div>
</div>

<div id="ip-results-tab" class="tab-content">
<div class="kpi-grid" id="ip-kpiGrid" style="display:none"></div>
<div class="form-section" id="ip-targetSection">
<div class="section-title">🎯 目標設定</div>
<div class="form-group">
<label>目標損益分岐点比率（％）</label>
<input type="number" id="ip-targetRate" placeholder="例: 95" value="100" inputmode="decimal" data-update="results" data-dept="inpatient">
</div>
<div class="form-group">
<label>目標経常利益（円）</label>
<input type="number" id="ip-targetProfit" placeholder="例: 20000000" inputmode="numeric" pattern="[0-9]*" data-update="target" data-dept="inpatient">
</div>
<div class="form-group">
<label>目標1日患者数（人）</label>
<input type="number" id="ip-targetDailyPatients" placeholder="例: 80" inputmode="numeric" pattern="[0-9]*" data-update="patient" data-dept="inpatient">
</div>
<div class="actions">
<button class="primary" data-action="updateResults" data-dept="inpatient">📊 結果を更新</button>
<button class="secondary" data-action="exportCSV" data-dept="inpatient">📊 CSVエクスポート</button>
<button class="secondary" data-action="print">🖨️ 印刷</button>
</div>
</div>
<div id="ip-results" class="result-box">
<div class="muted">計算結果がここに表示されます。まずデータ入力タブで必要な情報を入力してください。</div>
</div>
<div id="ip-targetAnalysisResults" class="result-box" style="display:none">
<div class="section-title">🎯 目標達成分析</div>
<div id="ip-targetAnalysisContent"></div>
</div>
<div id="ip-patientAnalysisResults" class="result-box" style="display:none">
<div class="section-title">👥 患者数目標分析</div>
<div id="ip-patientAnalysisContent"></div>
</div>
</div>

<div id="ip-sensitivity-tab" class="tab-content">
<div style="display:grid;grid-template-columns:1fr 1fr;gap:25px;align-items:start">
<div class="form-section">
<div class="section-title">🔍 収益影響シミュレーション</div>
<p class="muted">各パラメータを変動させて、経常利益への影響を確認できます。</p>
<p class="muted" style="color:#dc2626;font-weight:600">※保険外診療収益と過誤その他は変動させず、固定値として扱います</p>
<div class="sensitivity-controls">
<div class="slider-group">
<div class="slider-label">
<span>平均診療単価変動</span>
<span id="ip-priceVariation">±0円</span>
</div>
<div style="display:flex;align-items:center;gap:10px;margin-bottom:10px">
<button type="button" class="sensitivity-btn" data-adjust="price" data-dept="inpatient" data-delta="-500">－</button>
<input type="range" id="ip-priceSlider" min="-10000" max="10000" step="500" value="0" data-sensitivity="true" data-dept="inpatient" style="flex:1">
<button type="button" class="sensitivity-btn" data-adjust="price" data-dept="inpatient" data-delta="500">＋</button>
</div>
</div>
<div class="slider-group">
<div class="slider-label">
<span>1日患者数変動</span>
<span id="ip-patientVariation">±0人</span>
</div>
<div style="display:flex;align-items:center;gap:10px;margin-bottom:10px">
<button type="button" class="sensitivity-btn" data-adjust="patient" data-dept="inpatient" data-delta="-1">－</button>
<input type="range" id="ip-patientSlider" min="-30" max="30" step="1" value="0" data-sensitivity="true" data-dept="inpatient" style="flex:1">
<button type="button" class="sensitivity-btn" data-adjust="patient" data-dept="inpatient" data-delta="1">＋</button>
</div>
</div>
<div class="slider-group">
<div class="slider-label">
<span>変動費変動率</span>
<span id="ip-variableVariation">±0%</span>
</div>
<div style="display:flex;align-items:center;gap:10px;margin-bottom:10px">
<button type="button" class="sensitivity-btn" data-adjust="variable" data-dept="inpatient" data-delta="-1">－</button>
<input type="range" id="ip-variableSlider" min="-30" max="30" value="0" data-sensitivity="true" data-dept="inpatient" style="flex:1">
<button type="button" class="sensitivity-btn" data-adjust="variable" data-dept="inpatient" data-delta="1">＋</button>
</div>
</div>
<div class="slider-group">
<div class="slider-label">
<span>固定費変動率</span>
<span id="ip-fixedVariation">±0%</span>
</div>
<div style="display:flex;align-items:center;gap:10px;margin-bottom:10px">
<button type="button" class="sensitivity-btn" data-adjust="fixed" data-dept="inpatient" data-delta="-1">－</button>
<input type="range" id="ip-fixedSlider" min="-30" max="30" value="0" data-sensitivity="true" data-dept="inpatient" style="flex:1">
<button type="button" class="sensitivity-btn" data-adjust="fixed" data-dept="inpatient" data-delta="1">＋</button>
</div>
</div>
</div>
</div>
<div id="ip-sensitivityResults" class="result-box">
<div class="section-title">📊 収益影響シミュレーション結果</div>
<div id="ip-sensitivityContent">
<div class="muted">まずデータ入力タブで基本データを入力し、詳細分析を実行してください。</div>
</div>
</div>
</div>
</div>

<div id="ip-scenarios-tab" class="tab-content">
<div class="scenario-manager">
<div class="section-title">💡 月次データ管理</div>
<p class="muted">最大12ヶ月分の経営データを保存・比較できます。</p>
<div class="form-grid" style="grid-template-columns:1fr 1fr;gap:15px">
<div class="form-group">
<label>月度選択</label>
<select id="ip-monthSelect">
<option value="4">4月</option><option value="5">5月</option><option value="6">6月</option><option value="7">7月</option><option value="8">8月</option><option value="9">9月</option><option value="10">10月</option><option value="11">11月</option><option value="12">12月</option><option value="1">1月</option><option value="2">2月</option><option value="3">3月</option>
</select>
</div>
<div class="form-group">
<label>年度</label>
<select id="ip-yearSelect">
<option value="2024">2024年度</option><option value="2025" selected>2025年度</option><option value="2026">2026年度</option>
</select>
</div>
</div>
<div class="scenario-buttons">
<button class="primary" data-action="saveMonthly" data-dept="inpatient">💾 当月データを保存</button>
<button class="secondary" data-action="loadMonthly" data-dept="inpatient">📂 当月データを読み込み</button>
<button class="secondary" data-action="deleteMonthly" data-dept="inpatient">🗑️ 当月データを削除</button>
<button class="secondary" data-action="exportMonthly" data-dept="inpatient">📤 全データをエクスポート</button>
<label for="ip-importFile" class="secondary">📥 データをインポート</label>
<input type="file" id="ip-importFile" accept="application/json,.json" data-import="true" data-dept="inpatient" style="position:absolute;left:-9999px;width:1px;height:1px;opacity:0">
<button class="secondary" data-action="clearMonthly" data-dept="inpatient" style="background:#fee2e2;color:#991b1b;border-color:#fecaca">🗑️ 全データクリア</button>
</div>
</div>
<div id="ip-monthlyDataList" class="result-box">
<div class="section-title">📋 保存済み月次データ一覧</div>
<div id="ip-monthlyDataContent">
<div class="muted">保存されたデータがここに表示されます。</div>
</div>
</div>
<div class="result-box">
<div class="section-title">📊 月次比較表</div>
<div id="ip-comparisonTable" style="overflow-x:auto;-webkit-overflow-scrolling:touch">
<div class="muted">2ヶ月以上のデータが保存されると比較表が表示されます。</div>
</div>
</div>
</div>

<div id="ip-benchmark-tab" class="tab-content">
<div style="background:#fff;padding:25px;border-radius:15px;margin-bottom:25px;border:1px solid #e2e8f0">
<div class="section-title">🎯 損益分岐点比率 目標達成分析</div>
<p class="muted">損益分岐点比率100%（損益ゼロ）、95%（余裕あり）、任意設定（カスタム）の3パターンで、目標達成に必要な患者数・単価を算出します。</p>
<div class="form-group" style="max-width:300px;margin:20px 0">
<label>カスタム損益分岐点比率（%）</label>
<input type="number" id="ip-customBenchmarkRate" placeholder="例: 90" value="105" step="1" inputmode="decimal" data-update="benchmark" data-dept="inpatient">
<p class="muted" style="margin-top:5px;font-size:0.85rem">デフォルト: 105%（ギリギリ赤字）</p>
</div>
<div id="ip-benchmarkContent">
<div class="muted">まずデータ入力タブで基本データを入力し、詳細分析を実行してください。</div>
</div>
</div>
</div>
</div>

<footer>
<p>🏥 病院経営改善委員会プロジェクトチーム </p>
<p class="muted">このツールは完全にオフラインで動作し、データはブラウザ内にのみ保存されます。</p>
</footer>
</div>

<div id="monthlyPickerModal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="monthlyPickerTitle">
<div class="modal" onclick="event.stopPropagation()">
<div class="modal-header">
<div class="modal-title" id="monthlyPickerTitle">📂 保存データから月次データを取得</div>
<button class="modal-close" aria-label="閉じる" data-action="closePicker">×</button>
</div>
<div class="modal-body">
<p class="muted" style="margin:0 0 10px 0">読み込む月を選択してください。</p>
<div id="monthlyPickerList"></div>
</div>
<div class="modal-footer">
<button class="secondary" data-action="closePicker">キャンセル</button>
<button class="primary" id="monthlyPickerConfirmBtn" data-action="confirmPicker" disabled>読み込む</button>
</div>
</div>
</div>
<script>
// iOS/iPadOS検出（改善版）
const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || 
              (navigator.userAgent.includes('Mac') && navigator.maxTouchPoints > 1);
const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;

// LocalStorageのフォールバック対応（プライベートブラウズ検出機能追加）
const storage = (function() {
    let isPrivateMode = false;
    try {
        const test = '__test__';
        localStorage.setItem(test, '1');
        localStorage.removeItem(test);
        return localStorage;
    } catch(e) {
        isPrivateMode = true;
        // プライベートブラウジング警告表示
        setTimeout(function() {
            const notice = document.getElementById('privacy-notice');
            if (notice) notice.classList.add('show');
        }, 500);
        
        let memoryStorage = {};
        return {
            getItem: function(key) {
                return key in memoryStorage ? memoryStorage[key] : null;
            },
            setItem: function(key, value) {
                memoryStorage[key] = String(value);
            },
            removeItem: function(key) {
                delete memoryStorage[key];
            }
        };
    }
})();

// グローバル変数
let currentDept = 'outpatient';
let calcData = {
    outpatient: {},
    inpatient: {}
};
let monthlyData = {
    outpatient: JSON.parse(storage.getItem('hospitalOutpatientMonthlyData') || '{}'),
    inpatient: JSON.parse(storage.getItem('hospitalInpatientMonthlyData') || '{}')
};
let currentPickerDept = '';

// ユーティリティ関数
function pad2(n) {
    n = String(n);
    return n.length === 1 ? '0' + n : n;
}

function safeParseFloat(value, defaultValue = 0) {
    const parsed = parseFloat(value);
    return isNaN(parsed) ? defaultValue : parsed;
}

// ダウンロード処理（iOS対応改善版）
async function triggerDownload(options) {
    const fileName = options.fileName;
    const mimeType = options.mimeType;
    const blob = options.blob;
    
    try {
        // iOS/iPadOSの場合
        if (isIOS) {
            // Web Share APIを試す（iOS 15+）
            if (navigator.share && navigator.canShare) {
                try {
                    const file = new File([blob], fileName, { type: mimeType });
                    if (navigator.canShare({ files: [file] })) {
                        await navigator.share({
                            files: [file],
                            title: fileName
                        });
                        return; // 共有成功
                    }
                } catch (shareError) {
                    console.log('Web Share API failed:', shareError);
                }
            }
            
            // Web Share APIが使えない場合のフォールバック
            // 先に空のウィンドウを同期的に開く
            const newWindow = window.open('about:blank', '_blank');
            
            if (!newWindow) {
                alert('ポップアップがブロックされました。設定を確認してください。');
                return;
            }
            
            // CSVの場合は直接書き込み
            if (mimeType.includes('csv')) {
                const reader = new FileReader();
                reader.onload = function() {
                    newWindow.document.write(
                        '<html><head><title>' + fileName + '</title>' +
                        '<meta charset="utf-8">' +
                        '<style>body{font-family:monospace;white-space:pre-wrap;word-wrap:break-word;}</style>' +
                        '</head><body>' +
                        reader.result.replace(/</g, '&lt;').replace(/>/g, '&gt;') +
                        '</body></html>'
                    );
                    newWindow.document.close();
                };
                reader.readAsText(blob);
            } else {
                // JSONなどその他のファイル
                const reader = new FileReader();
                reader.onload = function() {
                    // データURLに遷移
                    newWindow.location.href = reader.result;
                };
                reader.readAsDataURL(blob);
            }
        } else {
            // 通常のダウンロード処理（非iOS）
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            setTimeout(function() {
                URL.revokeObjectURL(url);
            }, 1000);
        }
    } catch(e) {
        console.error('Download error:', e);
        alert('ダウンロードに失敗しました。');
    }
}

// アラート表示
function showAlert(message, type = 'info') {
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert ' + type;
    alertDiv.textContent = message;
    const container = document.querySelector('.container');
    container.insertBefore(alertDiv, container.firstChild);
    setTimeout(function() {
        if (alertDiv && alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

// 部門切り替え
function switchDepartment(dept, btn) {
    currentDept = dept;
    const deptBtns = document.querySelectorAll('.dept-btn');
    for (let i = 0; i < deptBtns.length; i++) {
        deptBtns[i].classList.remove('active');
    }
    btn.classList.add('active');
    
    document.getElementById('outpatient-section').style.display = 
        dept === 'outpatient' ? 'block' : 'none';
    document.getElementById('inpatient-section').style.display = 
        dept === 'inpatient' ? 'block' : 'none';
}

// タブ切り替え（修正版）
function switchTab(tabId, button) {
    const prefix = currentDept === 'outpatient' ? 'op' : 'ip';
    const tabPrefix = tabId.startsWith('op-') || tabId.startsWith('ip-') ? 
        tabId : prefix + '-' + tabId;
    const section = currentDept + '-section';
    
    // タブボタンのアクティブ状態を更新
    const tabButtons = document.querySelectorAll('#' + section + ' .tab-button');
    for (let i = 0; i < tabButtons.length; i++) {
        tabButtons[i].classList.remove('active');
    }
    button.classList.add('active');
    
    // タブコンテンツの表示切り替え
    const tabContents = document.querySelectorAll('#' + section + ' .tab-content');
    for (let i = 0; i < tabContents.length; i++) {
        tabContents[i].classList.remove('active');
    }
    
    const tabElement = document.getElementById(tabPrefix + '-tab');
    if (tabElement) {
        tabElement.classList.add('active');
        
        // 特定タブの初期化処理（currentDeptを使用）
        if (tabId.includes('scenarios')) {
            updateMonthlyDataList(currentDept);
            updateComparisonTable(currentDept);
        } else if (tabId.includes('benchmark')) {
            updateBenchmark(currentDept);
        } else if (tabId.includes('department')) {
            updateDepartmentCalc(currentDept);
        }
    }
}

// 収益計算ヘルパー関数（過誤その他追加版）
function calculateRevenues(dept) {
    const p = dept === 'outpatient' ? 'op' : 'ip';
    
    const insuranceModeElement = document.querySelector('input[name="' + p + '-insuranceMode"]:checked');
    const insuranceMode = insuranceModeElement ? insuranceModeElement.value : 'total';
    const insuranceInput = safeParseFloat(document.getElementById(p + '-insuranceRevenue').value);
    const nonInsuranceRevenue = safeParseFloat(document.getElementById(p + '-nonInsuranceRevenue').value);
    const otherRevenue = safeParseFloat(document.getElementById(p + '-otherRevenue').value);
    
    const patientModeElement = document.querySelector('input[name="' + p + '-patientMode"]:checked');
    const patientMode = patientModeElement ? patientModeElement.value : 'daily';
    const dailyPatients = safeParseFloat(document.getElementById(p + '-dailyPatients').value);
    const monthlyPatients = safeParseFloat(document.getElementById(p + '-monthlyPatients').value);
    
    let clinicDays;
    if (dept === 'outpatient') {
        const clinicDaysSelect = document.getElementById(p + '-clinicDays').value;
        const customDays = safeParseFloat(document.getElementById(p + '-customClinicDays').value);
        clinicDays = clinicDaysSelect === 'custom' ? customDays : safeParseFloat(clinicDaysSelect);
    } else {
        clinicDays = safeParseFloat(document.getElementById(p + '-clinicDays').value);
    }
    
    const totalPatients = (patientMode === 'daily') ? dailyPatients * clinicDays : monthlyPatients;
    
    let insuranceRevenue;
    if (insuranceMode === 'unit' && totalPatients > 0) {
        insuranceRevenue = insuranceInput * totalPatients;
    } else {
        insuranceRevenue = insuranceInput;
    }
    
    const totalRevenue = insuranceRevenue + nonInsuranceRevenue + otherRevenue;
    const avgPriceExcludingNonInsurance = totalPatients > 0 ? insuranceRevenue / totalPatients : 0;
    
    return {
        insuranceRevenue: insuranceRevenue,
        nonInsuranceRevenue: nonInsuranceRevenue,
        otherRevenue: otherRevenue,
        totalRevenue: totalRevenue,
        totalPatients: totalPatients,
        avgPriceExcludingNonInsurance: avgPriceExcludingNonInsurance,
        clinicDays: clinicDays,
        dailyPatients: (patientMode === 'daily') ? dailyPatients : (clinicDays > 0 ? monthlyPatients / clinicDays : 0)
    };
}

// 変動費計算ヘルパー関数（過誤その他対応版）
function calculateVariableCost(dept, revenues) {
    const p = dept === 'outpatient' ? 'op' : 'ip';
    
    const varModeElement = document.querySelector('input[name="' + p + '-varMode"]:checked');
    const varMode = varModeElement ? varModeElement.value : 'amount';
    const varInput = safeParseFloat(document.getElementById(p + '-variableCost').value);
    
    const includeInsurance = document.getElementById(p + '-varTargetInsurance').checked;
    const includeNonInsurance = document.getElementById(p + '-varTargetNonInsurance').checked;
    const includeOther = document.getElementById(p + '-varTargetOther').checked;
    
    let targetRevenue = 0;
    if (includeInsurance) targetRevenue += revenues.insuranceRevenue;
    if (includeNonInsurance) targetRevenue += revenues.nonInsuranceRevenue;
    if (includeOther) targetRevenue += revenues.otherRevenue;
    
    const variableCost = (varMode === 'rate') ? targetRevenue * (varInput / 100) : varInput;
    
    return {
        variableCost: variableCost,
        targetRevenue: targetRevenue
    };
}

// 保険外・過誤除外モード用の変動費計算
function calculateVariableCostExcludeMode(dept, revenues, excludeNonInsurance, excludeOther) {
    const p = dept === 'outpatient' ? 'op' : 'ip';
    
    const varModeElement = document.querySelector('input[name="' + p + '-varMode"]:checked');
    const varMode = varModeElement ? varModeElement.value : 'amount';
    const varInput = safeParseFloat(document.getElementById(p + '-variableCost').value);
    
    // 除外設定に応じた対象収益の計算
    let targetRevenue = revenues.insuranceRevenue; // 保険診療は常に含む
    if (!excludeNonInsurance) {
        targetRevenue += revenues.nonInsuranceRevenue;
    }
    if (!excludeOther) {
        targetRevenue += revenues.otherRevenue;
    }
    
    const variableCost = (varMode === 'rate') ? targetRevenue * (varInput / 100) : varInput;
    
    return {
        variableCost: variableCost,
        targetRevenue: targetRevenue
    };
}

// リアルタイム更新（過誤その他対応版）
function updateRealtime(dept) {
    try {
        const p = dept === 'outpatient' ? 'op' : 'ip';
        const revenues = calculateRevenues(dept);
        const fixedCost = safeParseFloat(document.getElementById(p + '-fixedCost').value);
        
        if (revenues.totalRevenue === 0) {
            document.getElementById(p + '-realtimeResults').style.display = 'none';
            return;
        }
        
        const varCalc = calculateVariableCost(dept, revenues);
        const margin = revenues.totalRevenue - varCalc.variableCost;
        const operatingProfit = margin - fixedCost;
        const variableRate = varCalc.targetRevenue > 0 ? (varCalc.variableCost / varCalc.targetRevenue * 100) : 0;
        const marginRate = revenues.totalRevenue > 0 ? (margin / revenues.totalRevenue * 100) : 0;
        
        const deptLabel = dept === 'outpatient' ? '外来' : '入院';
        
        const html = 
            '<div class="result-item"><span class="result-label">総売上高</span><span class="result-value">¥' + 
            revenues.totalRevenue.toLocaleString() + '</span></div>' +
            '<div class="result-item"><span class="result-label">保険診療売上高</span><span class="result-value">¥' + 
            revenues.insuranceRevenue.toLocaleString() + '</span></div>' +
            '<div class="result-item"><span class="result-label">保険外売上高</span><span class="result-value">¥' + 
            revenues.nonInsuranceRevenue.toLocaleString() + '</span></div>' +
            '<div class="result-item"><span class="result-label">過誤その他</span><span class="result-value">¥' + 
            revenues.otherRevenue.toLocaleString() + '</span></div>' +
            '<div class="result-item"><span class="result-label">変動費</span><span class="result-value">¥' + 
            varCalc.variableCost.toLocaleString() + ' (' + variableRate.toFixed(1) + '%)</span></div>' +
            '<div class="result-item"><span class="result-label">限界利益</span><span class="result-value">¥' + 
            margin.toLocaleString() + ' (' + marginRate.toFixed(1) + '%)</span></div>' +
            '<div class="result-item"><span class="result-label">固定費</span><span class="result-value">¥' + 
            fixedCost.toLocaleString() + '</span></div>' +
            '<div class="result-item"><span class="result-label">経常利益</span><span class="result-value ' + 
            (operatingProfit >= 0 ? 'positive' : 'negative') + '">¥' + 
            operatingProfit.toLocaleString() + '</span></div>' +
            '<div class="result-item"><span class="result-label">月間総' + deptLabel + 
            '患者数</span><span class="result-value">' + revenues.totalPatients.toFixed(0) + '人</span></div>' +
            '<div class="result-item"><span class="result-label">平均診療単価（保険外除く）</span><span class="result-value">¥' + 
            revenues.avgPriceExcludingNonInsurance.toFixed(0) + '</span></div>';
        
        document.getElementById(p + '-realtimeContent').innerHTML = html;
        document.getElementById(p + '-realtimeResults').style.display = 'block';
    } catch (error) {
        console.error('リアルタイム更新エラー:', error);
    }
}

// 詳細計算実行（過誤その他対応版）
function calculate(dept) {
    try {
        const p = dept === 'outpatient' ? 'op' : 'ip';
        const revenues = calculateRevenues(dept);
        const fixedCost = safeParseFloat(document.getElementById(p + '-fixedCost').value);
        
        if (revenues.totalRevenue === 0) {
            showAlert('売上高を入力してください。', 'error');
            return;
        }
        
        const analysisModeElement = document.querySelector('input[name="' + p + '-analysisMode"]:checked');
        const analysisMode = analysisModeElement ? analysisModeElement.value : 'include';
        
        const otherModeElement = document.querySelector('input[name="' + p + '-otherMode"]:checked');
        const otherMode = otherModeElement ? otherModeElement.value : 'include';
        
        // 分析モードに応じた売上高の選択
        let analysisRevenue = revenues.insuranceRevenue;
        if (analysisMode === 'include') {
            analysisRevenue += revenues.nonInsuranceRevenue;
        }
        if (otherMode === 'include') {
            analysisRevenue += revenues.otherRevenue;
        }
        
        // 変動費計算
        let varCalc;
        if (analysisMode === 'exclude' || otherMode === 'exclude') {
            varCalc = calculateVariableCostExcludeMode(
                dept, 
                revenues, 
                analysisMode === 'exclude',
                otherMode === 'exclude'
            );
        } else {
            varCalc = calculateVariableCost(dept, revenues);
        }
        
        const margin = analysisRevenue - varCalc.variableCost;
        const operatingProfit = margin - fixedCost;
        const breakEvenRate = margin > 0 ? (fixedCost / margin) * 100 : 0;
        const variableRate = analysisRevenue > 0 ? (varCalc.variableCost / analysisRevenue * 100) : 0;
        const marginRate = analysisRevenue > 0 ? (margin / analysisRevenue * 100) : 0;
        
        // 計算結果を保存
        calcData[dept] = {
            revenue: analysisRevenue,
            insuranceRevenue: revenues.insuranceRevenue,
            nonInsuranceRevenue: revenues.nonInsuranceRevenue,
            otherRevenue: revenues.otherRevenue,
            totalRevenue: revenues.totalRevenue,
            fixed: fixedCost,
            variableCost: varCalc.variableCost,
            margin: margin,
            operatingProfit: operatingProfit,
            breakEvenRate: breakEvenRate,
            clinicDays: revenues.clinicDays,
            totalPatients: revenues.totalPatients,
            finalAvgPrice: revenues.avgPriceExcludingNonInsurance,
            finalDailyPatients: revenues.dailyPatients,
            variableRate: variableRate,
            marginRate: marginRate,
            analysisMode: analysisMode,
            otherMode: otherMode,
            varTargetRevenue: varCalc.targetRevenue
        };
        
        showAlert('計算が完了しました。分析結果タブで詳細をご確認ください。', 'success');
        updateResults(dept);
        updateKPICards(dept);
        
        // 結果タブに切り替え
        const resultsBtn = document.querySelector('#' + dept + '-section .tab-button[data-tab="' + p + '-results"]');
        if (resultsBtn) {
            switchTab(p + '-results', resultsBtn);
        }
    } catch (error) {
        console.error('計算エラー:', error);
        showAlert('計算中にエラーが発生しました。', 'error');
    }
}

// KPIカード更新
function updateKPICards(dept) {
    const p = dept === 'outpatient' ? 'op' : 'ip';
    if (!calcData[dept].revenue) return;
    
    const kpiData = [
        {
            label: '経常利益',
            value: '¥' + calcData[dept].operatingProfit.toLocaleString(),
            positive: calcData[dept].operatingProfit >= 0
        },
        {
            label: '損益分岐点比率',
            value: calcData[dept].breakEvenRate.toFixed(1) + '%',
            positive: calcData[dept].breakEvenRate <= 100
        },
        {
            label: '限界利益率',
            value: calcData[dept].marginRate.toFixed(1) + '%',
            positive: calcData[dept].marginRate >= 60
        },
        {
            label: '1日患者数',
            value: calcData[dept].finalDailyPatients.toFixed(0) + '人',
            positive: calcData[dept].finalDailyPatients >= (dept === 'outpatient' ? 100 : 50)
        },
        {
            label: '平均診療単価',
            value: '¥' + calcData[dept].finalAvgPrice.toFixed(0),
            positive: calcData[dept].finalAvgPrice >= (dept === 'outpatient' ? 8000 : 20000)
        },
        {
            label: '変動費率',
            value: calcData[dept].variableRate.toFixed(1) + '%',
            positive: calcData[dept].variableRate <= 40
        }
    ];
    
    let html = '';
    for (let i = 0; i < kpiData.length; i++) {
        const kpi = kpiData[i];
        const bgColor = kpi.positive ? 
            'linear-gradient(135deg,#059669 0%,#34d399 100%)' : 
            'linear-gradient(135deg,#dc2626 0%,#f87171 100%)';
        html += '<div class="kpi-card" style="background:' + bgColor + '">' +
            '<div class="kpi-value">' + kpi.value + '</div>' +
            '<div class="kpi-label">' + kpi.label + '</div>' +
            '</div>';
    }
    
    document.getElementById(p + '-kpiGrid').innerHTML = html;
    document.getElementById(p + '-kpiGrid').style.display = 'grid';
}

// 結果更新（過誤その他対応版）
function updateResults(dept) {
    const p = dept === 'outpatient' ? 'op' : 'ip';
    if (!calcData[dept].revenue) {
        showAlert('先にデータ入力タブで計算を実行してください。', 'warning');
        return;
    }
    
    const targetRate = safeParseFloat(document.getElementById(p + '-targetRate').value, 100);
    const currentBreakEven = calcData[dept].fixed / (calcData[dept].margin / calcData[dept].revenue);
    const targetRevenue = currentBreakEven / (targetRate / 100);
    const targetPatients = calcData[dept].finalAvgPrice > 0 ? 
        targetRevenue / calcData[dept].finalAvgPrice : 0;
    const targetDailyPatients = calcData[dept].clinicDays > 0 ? 
        targetPatients / calcData[dept].clinicDays : 0;
    const profitPerPatient = calcData[dept].totalPatients > 0 ? 
        calcData[dept].margin / calcData[dept].totalPatients : 0;
    
    const deptLabel = dept === 'outpatient' ? '外来' : '入院';
    
    // 分析モードラベルの生成
    let analysisLabel = '';
    if (calcData[dept].analysisMode === 'include' && calcData[dept].otherMode === 'include') {
        analysisLabel = '（保険外・過誤含む）';
    } else if (calcData[dept].analysisMode === 'exclude' && calcData[dept].otherMode === 'exclude') {
        analysisLabel = '（保険外・過誤除く）';
    } else if (calcData[dept].analysisMode === 'exclude') {
        analysisLabel = '（保険外除く、過誤含む）';
    } else if (calcData[dept].otherMode === 'exclude') {
        analysisLabel = '（保険外含む、過誤除く）';
    }
    
    const html = 
        '<div class="result-item"><span class="result-label">分析モード</span>' +
        '<span class="result-value">' + analysisLabel + '</span></div>' +
        '<div class="result-item"><span class="result-label">経常利益</span>' +
        '<span class="result-value ' + (calcData[dept].operatingProfit >= 0 ? 'positive' : 'negative') + '">¥' +
        calcData[dept].operatingProfit.toLocaleString() + '</span></div>' +
        '<div class="result-item"><span class="result-label">損益分岐点比率</span>' +
        '<span class="result-value">' + calcData[dept].breakEvenRate.toFixed(1) + '%</span></div>' +
        '<div class="result-item"><span class="result-label">限界利益（粗利）</span>' +
        '<span class="result-value">¥' + calcData[dept].margin.toLocaleString() + '</span></div>' +
        '<div class="result-item"><span class="result-label">限界利益率</span>' +
        '<span class="result-value">' + calcData[dept].marginRate.toFixed(1) + '%</span></div>' +
        '<div class="result-item"><span class="result-label">変動費率</span>' +
        '<span class="result-value">' + calcData[dept].variableRate.toFixed(1) + '%</span></div>' +
        '<div class="result-item"><span class="result-label">月間診療日数</span>' +
        '<span class="result-value">' + calcData[dept].clinicDays + '日</span></div>' +
        '<div class="result-item"><span class="result-label">1日平均' + deptLabel + '患者数</span>' +
        '<span class="result-value">' + calcData[dept].finalDailyPatients.toFixed(1) + '人</span></div>' +
        '<div class="result-item"><span class="result-label">月間総' + deptLabel + '患者数</span>' +
        '<span class="result-value">' + calcData[dept].totalPatients.toFixed(0) + '人</span></div>' +
        '<div class="result-item"><span class="result-label">平均診療単価（保険外除く）</span>' +
        '<span class="result-value">¥' + calcData[dept].finalAvgPrice.toFixed(0) + '</span></div>' +
        '<div class="result-item"><span class="result-label">患者1人あたりの限界利益</span>' +
        '<span class="result-value">¥' + Math.round(profitPerPatient).toLocaleString() + '</span></div>' +
        '<hr style="margin:20px 0;border:none;border-top:2px solid #e2e8f0">' +
        '<div class="result-item"><span class="result-label">目標損益分岐点比率</span>' +
        '<span class="result-value">' + targetRate + '%</span></div>' +
        '<div class="result-item"><span class="result-label">必要な1日患者数</span>' +
        '<span class="result-value">' + targetDailyPatients.toFixed(1) + '人</span></div>' +
        '<div class="result-item"><span class="result-label">必要な月間患者数</span>' +
        '<span class="result-value">' + Math.round(targetPatients).toLocaleString() + '人</span></div>';
    
    document.getElementById(p + '-results').innerHTML = html;
}

// 感度分析更新（過誤その他対応版）
function updateSensitivity(dept) {
    const p = dept === 'outpatient' ? 'op' : 'ip';
    if (!calcData[dept].revenue) {
        document.getElementById(p + '-sensitivityContent').innerHTML = 
            '<div class="muted">まずデータ入力タブで基本データを入力し、詳細分析を実行してください。</div>';
        return;
    }
    
    const priceVariation = safeParseFloat(document.getElementById(p + '-priceSlider').value);
    const patientVariation = safeParseFloat(document.getElementById(p + '-patientSlider').value);
    const variableVariation = safeParseFloat(document.getElementById(p + '-variableSlider').value);
    const fixedVariation = safeParseFloat(document.getElementById(p + '-fixedSlider').value);
    
    document.getElementById(p + '-priceVariation').textContent = 
        (priceVariation >= 0 ? '+' : '') + priceVariation + '円';
    document.getElementById(p + '-patientVariation').textContent = 
        (patientVariation >= 0 ? '+' : '') + patientVariation + '人';
    document.getElementById(p + '-variableVariation').textContent = 
        (variableVariation >= 0 ? '+' : '') + variableVariation + '%';
    document.getElementById(p + '-fixedVariation').textContent = 
        (fixedVariation >= 0 ? '+' : '') + fixedVariation + '%';
    
    // 保険診療のみで計算
    const newPrice = calcData[dept].finalAvgPrice + priceVariation;
    const newDailyPatients = calcData[dept].finalDailyPatients + patientVariation;
    const newMonthlyPatients = newDailyPatients * calcData[dept].clinicDays;
    const newInsuranceRevenue = newPrice * newMonthlyPatients;
    
    // 保険外診療収益と過誤その他を正しく取得
    const nonInsuranceRevenue = calcData[dept].nonInsuranceRevenue || 0;
    const otherRevenue = calcData[dept].otherRevenue || 0;
    const newTotalRevenue = newInsuranceRevenue + nonInsuranceRevenue + otherRevenue;
    
    // 変動費の計算（保険診療収益に対する変動費率を使用）
    let baseVariableRate;
    if (calcData[dept].insuranceRevenue > 0) {
        // 保険診療収益に対する変動費率を計算
        baseVariableRate = calcData[dept].variableCost / calcData[dept].insuranceRevenue;
    } else {
        baseVariableRate = 0;
    }
    
    const newVariableRate = baseVariableRate * (1 + variableVariation / 100);
    const newVariableCost = newInsuranceRevenue * newVariableRate;
    const newFixedCost = calcData[dept].fixed * (1 + fixedVariation / 100);
    const newMargin = newInsuranceRevenue - newVariableCost;
    const newProfit = newMargin + nonInsuranceRevenue + otherRevenue - newFixedCost;
    
    const profitChange = newProfit - calcData[dept].operatingProfit;
    const profitChangeRate = calcData[dept].operatingProfit !== 0 ? 
        (profitChange / Math.abs(calcData[dept].operatingProfit)) * 100 : 0;
    
    const newActualVariableRate = newInsuranceRevenue > 0 ? (newVariableCost / newInsuranceRevenue * 100) : 0;
    const newMarginRate = newTotalRevenue > 0 ? ((newInsuranceRevenue - newVariableCost + nonInsuranceRevenue + otherRevenue) / newTotalRevenue * 100) : 0;
    
    const html = 
        '<div class="result-item"><span class="result-label">変動後　診療単価</span>' +
        '<span class="result-value">¥' + Math.round(newPrice).toLocaleString() + '</span></div>' +
        '<div class="result-item"><span class="result-label">変動後　1日患者数</span>' +
        '<span class="result-value">' + Math.round(newDailyPatients) + '人</span></div>' +
        '<div class="result-item"><span class="result-label">変動後　月間総患者数</span>' +
        '<span class="result-value">' + Math.round(newMonthlyPatients) + '人</span></div>' +
        '<div class="result-item"><span class="result-label">変動後　保険診療売上高</span>' +
        '<span class="result-value">¥' + Math.round(newInsuranceRevenue).toLocaleString() + '</span></div>' +
        '<div class="result-item"><span class="result-label">変動後　保険外診療売上高</span>' +
        '<span class="result-value">¥' + Math.round(nonInsuranceRevenue).toLocaleString() + '</span></div>' +
        '<div class="result-item"><span class="result-label">変動後　過誤その他</span>' +
        '<span class="result-value">¥' + Math.round(otherRevenue).toLocaleString() + '</span></div>' +
        '<div class="result-item"><span class="result-label">変動後　総売上高</span>' +
        '<span class="result-value">¥' + Math.round(newTotalRevenue).toLocaleString() + '</span></div>' +
        '<div class="result-item"><span class="result-label">変動後　変動費（保険診療分）</span>' +
        '<span class="result-value">¥' + Math.round(newVariableCost).toLocaleString() + 
        ' (' + newActualVariableRate.toFixed(1) + '%)</span></div>' +
        '<div class="result-item"><span class="result-label">変動後　限界利益（粗利）</span>' +
        '<span class="result-value">¥' + Math.round(newMargin + nonInsuranceRevenue + otherRevenue).toLocaleString() + 
        ' (' + newMarginRate.toFixed(1) + '%)</span></div>' +
        '<div class="result-item"><span class="result-label">変動後　固定費</span>' +
        '<span class="result-value">¥' + Math.round(newFixedCost).toLocaleString() + '</span></div>' +
        '<div class="result-item"><span class="result-label">変動後　経常利益</span>' +
        '<span class="result-value ' + (newProfit >= 0 ? 'positive' : 'negative') + '">¥' +
        Math.round(newProfit).toLocaleString() + '</span></div>' +
        '<div class="result-item"><span class="result-label">利益変動額</span>' +
        '<span class="result-value ' + (profitChange >= 0 ? 'positive' : 'negative') + '">¥' +
        Math.round(profitChange).toLocaleString() + ' (' + 
        (profitChangeRate >= 0 ? '+' : '') + Math.round(profitChangeRate) + '%)</span></div>';
    
    document.getElementById(p + '-sensitivityContent').innerHTML = html;
}

// 月次データ保存（過誤その他対応版）
function saveMonthlyData(dept) {
    const p = dept === 'outpatient' ? 'op' : 'ip';
    if (!calcData[dept].revenue) {
        showAlert('保存するデータがありません。まず計算を実行してください。', 'error');
        return;
    }
    
    const key = getMonthKey(dept);
    const label = getMonthLabel(key);
    
    // 現在の入力値も保存
    const inputData = {
        insuranceRevenue: document.getElementById(p + '-insuranceRevenue').value,
        nonInsuranceRevenue: document.getElementById(p + '-nonInsuranceRevenue').value,
        otherRevenue: document.getElementById(p + '-otherRevenue').value,
        variableCost: document.getElementById(p + '-variableCost').value,
        fixedCost: document.getElementById(p + '-fixedCost').value,
        dailyPatients: document.getElementById(p + '-dailyPatients').value,
        monthlyPatients: document.getElementById(p + '-monthlyPatients').value,
        clinicDays: document.getElementById(p + '-clinicDays').value,
        customClinicDays: dept === 'outpatient' ? 
            document.getElementById(p + '-customClinicDays').value : '',
        insuranceMode: document.querySelector('input[name="' + p + '-insuranceMode"]:checked').value,
        varMode: document.querySelector('input[name="' + p + '-varMode"]:checked').value,
        patientMode: document.querySelector('input[name="' + p + '-patientMode"]:checked').value,
        analysisMode: document.querySelector('input[name="' + p + '-analysisMode"]:checked').value,
        otherMode: document.querySelector('input[name="' + p + '-otherMode"]:checked').value,
        varTargetInsurance: document.getElementById(p + '-varTargetInsurance').checked,
        varTargetNonInsurance: document.getElementById(p + '-varTargetNonInsurance').checked,
        varTargetOther: document.getElementById(p + '-varTargetOther').checked
    };
    
    // データを保存（ディープコピー）
    monthlyData[dept][key] = JSON.parse(JSON.stringify({
        ...calcData[dept],
        timestamp: new Date().toISOString(),
        inputs: inputData
    }));
    
    const storageKey = dept === 'outpatient' ? 
        'hospitalOutpatientMonthlyData' : 'hospitalInpatientMonthlyData';
    storage.setItem(storageKey, JSON.stringify(monthlyData[dept]));
    
    showAlert(label + 'のデータを保存しました。', 'success');
    updateMonthlyDataList(dept);
    updateComparisonTable(dept);
}

// 月次データ読み込み（過誤その他対応版）
function loadMonthlyData(dept) {
    const p = dept === 'outpatient' ? 'op' : 'ip';
    const key = getMonthKey(dept);
    const label = getMonthLabel(key);
    
    if (!monthlyData[dept][key]) {
        showAlert(label + 'のデータが存在しません。', 'error');
        return;
    }
    
    const data = monthlyData[dept][key];
    
    // 入力値を復元
    if (data.inputs) {
        const inputs = data.inputs;
        const elements = {
            insuranceRevenue: document.getElementById(p + '-insuranceRevenue'),
            nonInsuranceRevenue: document.getElementById(p + '-nonInsuranceRevenue'),
            otherRevenue: document.getElementById(p + '-otherRevenue'),
            variableCost: document.getElementById(p + '-variableCost'),
            fixedCost: document.getElementById(p + '-fixedCost'),
            dailyPatients: document.getElementById(p + '-dailyPatients'),
            monthlyPatients: document.getElementById(p + '-monthlyPatients'),
            clinicDays: document.getElementById(p + '-clinicDays')
        };
        
        // 要素の存在確認と値の設定
        if (elements.insuranceRevenue) elements.insuranceRevenue.value = inputs.insuranceRevenue || '';
        if (elements.nonInsuranceRevenue) elements.nonInsuranceRevenue.value = inputs.nonInsuranceRevenue || '';
        if (elements.otherRevenue) elements.otherRevenue.value = inputs.otherRevenue || '0';
        if (elements.variableCost) elements.variableCost.value = inputs.variableCost || '';
        if (elements.fixedCost) elements.fixedCost.value = inputs.fixedCost || '';
        if (elements.dailyPatients) elements.dailyPatients.value = inputs.dailyPatients || '';
        if (elements.monthlyPatients) elements.monthlyPatients.value = inputs.monthlyPatients || '';
        if (elements.clinicDays) elements.clinicDays.value = inputs.clinicDays || '22';
        
        // 外来の場合のカスタム診療日数
        if (dept === 'outpatient') {
            const customDays = document.getElementById(p + '-customClinicDays');
            if (customDays) {
                customDays.value = inputs.customClinicDays || '';
                customDays.style.display = inputs.clinicDays === 'custom' ? 'block' : 'none';
            }
        }
        
        // ラジオボタンの設定
        const insuranceModeRadio = document.querySelector('input[name="' + p + '-insuranceMode"][value="' + inputs.insuranceMode + '"]');
        if (insuranceModeRadio) insuranceModeRadio.checked = true;
        
        const varModeRadio = document.querySelector('input[name="' + p + '-varMode"][value="' + inputs.varMode + '"]');
        if (varModeRadio) varModeRadio.checked = true;
        
        const patientModeRadio = document.querySelector('input[name="' + p + '-patientMode"][value="' + inputs.patientMode + '"]');
        if (patientModeRadio) patientModeRadio.checked = true;
        
        const analysisModeRadio = document.querySelector('input[name="' + p + '-analysisMode"][value="' + inputs.analysisMode + '"]');
        if (analysisModeRadio) analysisModeRadio.checked = true;
        
        const otherModeRadio = document.querySelector('input[name="' + p + '-otherMode"][value="' + (inputs.otherMode || 'include') + '"]');
        if (otherModeRadio) otherModeRadio.checked = true;
        
        // チェックボックスの設定
        const varTargetInsurance = document.getElementById(p + '-varTargetInsurance');
        if (varTargetInsurance) varTargetInsurance.checked = inputs.varTargetInsurance !== false;
        
        const varTargetNonInsurance = document.getElementById(p + '-varTargetNonInsurance');
        if (varTargetNonInsurance) varTargetNonInsurance.checked = inputs.varTargetNonInsurance === true;
        
        const varTargetOther = document.getElementById(p + '-varTargetOther');
        if (varTargetOther) varTargetOther.checked = inputs.varTargetOther === true;
    }
    
    // 計算データをディープコピー
    calcData[dept] = JSON.parse(JSON.stringify(data));
    
    showAlert(label + 'のデータを読み込みました。', 'success');
    updateRealtime(dept);
    updateResults(dept);
    updateKPICards(dept);
    
    // 入力タブに切り替え
    const inputBtn = document.querySelector('#' + dept + '-section .tab-button[data-tab="' + p + '-input"]');
    if (inputBtn) {
        switchTab(p + '-input', inputBtn);
    }
}

// CSVエクスポート（過誤その他対応版）
async function exportToCSV(dept) {
    if (!calcData[dept].revenue) {
        showAlert('エクスポートするデータがありません。', 'error');
        return;
    }
    
    const deptLabel = dept === 'outpatient' ? '外来' : '入院';
    const csvData = [
        ['項目', '値'],
        ['総売上高', calcData[dept].totalRevenue],
        ['保険診療売上高', calcData[dept].insuranceRevenue],
        ['保険外売上高', calcData[dept].nonInsuranceRevenue],
        ['過誤その他', calcData[dept].otherRevenue || 0],
        ['経常利益', calcData[dept].operatingProfit],
        ['損益分岐点比率(%)', calcData[dept].breakEvenRate.toFixed(1)],
        ['1日平均' + deptLabel + '患者数', calcData[dept].finalDailyPatients.toFixed(1)],
        ['平均診療単価（保険外除く）', calcData[dept].finalAvgPrice.toFixed(0)]
    ];
    
    let csvContent = '';
    for (let i = 0; i < csvData.length; i++) {
        csvContent += csvData[i].join(',') + '\n';
    }
    
    const bom = '\uFEFF';
    const text = bom + csvContent;
    
    // iOS向け最適化：同期的にdata URLを作成して開く
    if (isIOS && !navigator.share) {
        const dataUrl = 'data:text/csv;charset=utf-8,' + encodeURIComponent(text);
        const newWindow = window.open(dataUrl, '_blank');
        if (newWindow) {
            showAlert('新しいタブでCSVを開きました。', 'success');
        }
        return;
    }
    
    // 通常のBlob処理
    const blob = new Blob([text], {type: 'text/csv;charset=utf-8;'});
    const fileName = deptLabel + '経営分析結果_' + 
        new Date().toISOString().split('T')[0] + '.csv';
    
    await triggerDownload({
        fileName: fileName,
        mimeType: 'text/csv;charset=utf-8;',
        blob: blob
    });
    
    showAlert('CSVをエクスポートしました。', 'success');
}

// その他の関数（変更なし）
function getMonthKey(dept) {
    const p = dept === 'outpatient' ? 'op' : 'ip';
    const month = document.getElementById(p + '-monthSelect').value;
    const year = document.getElementById(p + '-yearSelect').value;
    return year + '-' + pad2(month);
}

function getMonthLabel(key) {
    const parts = key.split('-');
    const year = parts[0];
    const month = parseInt(parts[1]);
    return year + '年' + month + '月';
}

// 以下、残りの関数も同様に続きます（文字数制限のため省略）
// 主要な変更点：
// 1. calculateRevenues関数に otherRevenue を追加
// 2. calculateVariableCost関数に過誤その他の対象チェックを追加
// 3. calculate関数に otherMode の処理を追加
// 4. updateResults, updateSensitivity関数に過誤その他の表示を追加
// 5. saveMonthlyData, loadMonthlyData関数に過誤その他のデータ保存・読み込みを追加

// 目標分析更新
function updateTargetAnalysis(dept) {
    const p = dept === 'outpatient' ? 'op' : 'ip';
    if (!calcData[dept].revenue) return;
    
    const targetProfit = safeParseFloat(document.getElementById(p + '-targetProfit').value);
    if (targetProfit === 0) {
        document.getElementById(p + '-targetAnalysisResults').style.display = 'none';
        return;
    }
    
    const requiredMargin = calcData[dept].fixed + targetProfit;
    const requiredRevenue = requiredMargin / (1 - calcData[dept].variableCost / calcData[dept].revenue);
    const revenueIncrease = requiredRevenue - calcData[dept].revenue;
    const revenueIncreaseRate = (revenueIncrease / calcData[dept].revenue) * 100;
    const requiredPatients = calcData[dept].finalAvgPrice > 0 ? 
        requiredRevenue / calcData[dept].finalAvgPrice : 0;
    const patientIncrease = requiredPatients - calcData[dept].totalPatients;
    const dailyPatientIncrease = calcData[dept].clinicDays > 0 ? 
        patientIncrease / calcData[dept].clinicDays : 0;
    
    const html = 
        '<div class="result-item"><span class="result-label">目標経常利益</span>' +
        '<span class="result-value">¥' + targetProfit.toLocaleString() + '</span></div>' +
        '<div class="result-item"><span class="result-label">必要売上高</span>' +
        '<span class="result-value">¥' + requiredRevenue.toLocaleString() + '</span></div>' +
        '<div class="result-item"><span class="result-label">売上高増加額</span>' +
        '<span class="result-value ' + (revenueIncrease >= 0 ? 'positive' : 'negative') + '">¥' +
        revenueIncrease.toLocaleString() + ' (' + revenueIncreaseRate.toFixed(1) + '%)</span></div>' +
        '<div class="result-item"><span class="result-label">必要月間患者数</span>' +
        '<span class="result-value">' + Math.round(requiredPatients).toLocaleString() + '人</span></div>' +
        '<div class="result-item"><span class="result-label">患者数増加</span>' +
        '<span class="result-value ' + (patientIncrease >= 0 ? 'positive' : 'negative') + '">' +
        Math.round(patientIncrease).toLocaleString() + '人</span></div>' +
        '<div class="result-item"><span class="result-label">1日あたり患者数増加</span>' +
        '<span class="result-value ' + (dailyPatientIncrease >= 0 ? 'positive' : 'negative') + '">' +
        dailyPatientIncrease.toFixed(1) + '人</span></div>';
    
    document.getElementById(p + '-targetAnalysisContent').innerHTML = html;
    document.getElementById(p + '-targetAnalysisResults').style.display = 'block';
}

// 患者数分析更新
function updatePatientAnalysis(dept) {
    const p = dept === 'outpatient' ? 'op' : 'ip';
    if (!calcData[dept].revenue) return;
    
    const targetDailyPatients = safeParseFloat(document.getElementById(p + '-targetDailyPatients').value);
    if (targetDailyPatients === 0) {
        document.getElementById(p + '-patientAnalysisResults').style.display = 'none';
        return;
    }
    
    const targetMonthlyPatients = targetDailyPatients * calcData[dept].clinicDays;
    const targetRevenue = targetMonthlyPatients * calcData[dept].finalAvgPrice;
    const targetVariableCost = targetRevenue * (calcData[dept].variableCost / calcData[dept].revenue);
    const targetMargin = targetRevenue - targetVariableCost;
    const targetProfit = targetMargin - calcData[dept].fixed;
    const patientIncrease = targetDailyPatients - calcData[dept].finalDailyPatients;
    const revenueIncrease = targetRevenue - calcData[dept].revenue;
    const profitIncrease = targetProfit - calcData[dept].operatingProfit;
    
    const html = 
        '<div class="result-item"><span class="result-label">目標1日患者数</span>' +
        '<span class="result-value">' + targetDailyPatients + '人</span></div>' +
        '<div class="result-item"><span class="result-label">目標月間患者数</span>' +
        '<span class="result-value">' + targetMonthlyPatients.toLocaleString() + '人</span></div>' +
        '<div class="result-item"><span class="result-label">予想売上高</span>' +
        '<span class="result-value">¥' + targetRevenue.toLocaleString() + '</span></div>' +
        '<div class="result-item"><span class="result-label">予想経常利益</span>' +
        '<span class="result-value ' + (targetProfit >= 0 ? 'positive' : 'negative') + '">¥' +
        targetProfit.toLocaleString() + '</span></div>' +
        '<div class="result-item"><span class="result-label">患者数増加</span>' +
        '<span class="result-value ' + (patientIncrease >= 0 ? 'positive' : 'negative') + '">' +
        patientIncrease.toFixed(1) + '人/日</span></div>' +
        '<div class="result-item"><span class="result-label">売上増加</span>' +
        '<span class="result-value ' + (revenueIncrease >= 0 ? 'positive' : 'negative') + '">¥' +
        revenueIncrease.toLocaleString() + '</span></div>' +
        '<div class="result-item"><span class="result-label">利益増加</span>' +
        '<span class="result-value ' + (profitIncrease >= 0 ? 'positive' : 'negative') + '">¥' +
        profitIncrease.toLocaleString() + '</span></div>';
    
    document.getElementById(p + '-patientAnalysisContent').innerHTML = html;
    document.getElementById(p + '-patientAnalysisResults').style.display = 'block';
}

// 感度分析調整
function adjustSensitivity(dept, type, delta) {
    const p = dept === 'outpatient' ? 'op' : 'ip';
    const sliders = {
        'price': document.getElementById(p + '-priceSlider'),
        'patient': document.getElementById(p + '-patientSlider'),
        'variable': document.getElementById(p + '-variableSlider'),
        'fixed': document.getElementById(p + '-fixedSlider')
    };
    
    const slider = sliders[type];
    if (!slider) return;
    
    const currentValue = safeParseFloat(slider.value);
    const min = safeParseFloat(slider.min);
    const max = safeParseFloat(slider.max);
    const step = safeParseFloat(slider.step, 1);
    
    let newValue;
    if (type === 'price') {
        newValue = Math.max(min, Math.min(max, currentValue + delta));
    } else {
        newValue = Math.max(min, Math.min(max, currentValue + (delta * step)));
    }
    
    slider.value = newValue;
    updateSensitivity(dept);
}

// ベンチマーク更新
function updateBenchmark(dept) {
    const p = dept === 'outpatient' ? 'op' : 'ip';
    if (!calcData[dept].revenue) {
        document.getElementById(p + '-benchmarkContent').innerHTML = 
            '<div class="muted">まずデータ入力タブで基本データを入力し、詳細分析を実行してください。</div>';
        return;
    }
    
    function calculateBenchmark(targetRate) {
        const currentBreakEven = calcData[dept].fixed / (calcData[dept].margin / calcData[dept].revenue);
        const targetRevenue = currentBreakEven / (targetRate / 100);
        const targetTotalPatients = calcData[dept].finalAvgPrice > 0 ? 
            targetRevenue / calcData[dept].finalAvgPrice : 0;
        const patientDiff = targetTotalPatients - calcData[dept].totalPatients;
        const targetPrice = calcData[dept].totalPatients > 0 ? 
            targetRevenue / calcData[dept].totalPatients : 0;
        const priceDiff = targetPrice - calcData[dept].finalAvgPrice;
        
        return {
            targetRevenue: targetRevenue,
            targetTotalPatients: targetTotalPatients,
            patientDiff: patientDiff,
            targetPrice: targetPrice,
            priceDiff: priceDiff
        };
    }
    
    const customRate = safeParseFloat(document.getElementById(p + '-customBenchmarkRate').value, 105);
    const benchmark100 = calculateBenchmark(100);
    const benchmark95 = calculateBenchmark(95);
    const benchmarkCustom = calculateBenchmark(customRate);
    
    const deptLabel = dept === 'outpatient' ? '外来' : '入院';
    
    const html = 
        '<div style="background:#fff;padding:20px;border-radius:10px;margin-bottom:20px">' +
        '<div style="font-size:1.1rem;font-weight:700;color:#1e293b;margin-bottom:15px">📊 現状</div>' +
        '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px">' +
        '<div><div style="font-size:.9rem;color:#6b7280">損益分岐点比率</div>' +
        '<div style="font-size:1.5rem;font-weight:700;color:' + 
        (calcData[dept].breakEvenRate <= 100 ? '#059669' : '#dc2626') + '">' +
        calcData[dept].breakEvenRate.toFixed(1) + '%</div></div>' +
        '<div><div style="font-size:.9rem;color:#6b7280">月間総' + deptLabel + '患者数</div>' +
        '<div style="font-size:1.5rem;font-weight:700;color:#4f46e5">' +
        calcData[dept].totalPatients.toFixed(0) + '人</div></div>' +
        '<div><div style="font-size:.9rem;color:#6b7280">平均診療単価（保険外除く）</div>' +
        '<div style="font-size:1.5rem;font-weight:700;color:#4f46e5">¥' +
        calcData[dept].finalAvgPrice.toFixed(0) + '</div></div>' +
        '</div></div>' +
        
        '<div class="benchmark-section" style="background:#dcfce7;border-color:#86efac">' +
        '<div class="benchmark-title" style="color:#065f46">① 損益分岐点比率 100% との比較（損益ゼロ）</div>' +
        '<div class="benchmark-item"><span>目標売上高</span><span style="font-weight:700">¥' +
        benchmark100.targetRevenue.toLocaleString() + '</span></div>' +
        '<div class="benchmark-item"><span>必要な月間総患者数（単価固定）</span>' +
        '<span style="font-weight:700;color:' + (benchmark100.patientDiff >= 0 ? '#dc2626' : '#059669') + '">' +
        benchmark100.targetTotalPatients.toFixed(0) + '人 (' + 
        (benchmark100.patientDiff >= 0 ? '+' : '') + benchmark100.patientDiff.toFixed(0) + '人)</span></div>' +
        '<div class="benchmark-item"><span>必要な平均単価（患者数固定）</span>' +
        '<span style="font-weight:700;color:' + (benchmark100.priceDiff >= 0 ? '#dc2626' : '#059669') + '">¥' +
        benchmark100.targetPrice.toFixed(0) + ' (' + 
        (benchmark100.priceDiff >= 0 ? '+' : '') + '¥' + benchmark100.priceDiff.toFixed(0) + ')</span></div>' +
        '</div>' +
        
        '<div class="benchmark-section" style="background:#dbeafe;border-color:#93c5fd">' +
        '<div class="benchmark-title" style="color:#1e40af">② 損益分岐点比率 95% との比較（余裕のある経営）</div>' +
        '<div class="benchmark-item"><span>目標売上高</span><span style="font-weight:700">¥' +
        benchmark95.targetRevenue.toLocaleString() + '</span></div>' +
        '<div class="benchmark-item"><span>必要な月間総患者数（単価固定）</span>' +
        '<span style="font-weight:700;color:' + (benchmark95.patientDiff >= 0 ? '#dc2626' : '#059669') + '">' +
        benchmark95.targetTotalPatients.toFixed(0) + '人 (' + 
        (benchmark95.patientDiff >= 0 ? '+' : '') + benchmark95.patientDiff.toFixed(0) + '人)</span></div>' +
        '<div class="benchmark-item"><span>必要な平均単価（患者数固定）</span>' +
        '<span style="font-weight:700;color:' + (benchmark95.priceDiff >= 0 ? '#dc2626' : '#059669') + '">¥' +
        benchmark95.targetPrice.toFixed(0) + ' (' + 
        (benchmark95.priceDiff >= 0 ? '+' : '') + '¥' + benchmark95.priceDiff.toFixed(0) + ')</span></div>' +
        '</div>' +
        
        '<div class="benchmark-section" style="background:#fef3c7;border-color:#fde68a">' +
        '<div class="benchmark-title" style="color:#92400e">③ 損益分岐点比率 ' + customRate + '% との比較（カスタム設定）</div>' +
        '<div class="benchmark-item"><span>目標売上高</span><span style="font-weight:700">¥' +
        benchmarkCustom.targetRevenue.toLocaleString() + '</span></div>' +
        '<div class="benchmark-item"><span>必要な月間総患者数（単価固定）</span>' +
        '<span style="font-weight:700;color:' + (benchmarkCustom.patientDiff >= 0 ? '#dc2626' : '#059669') + '">' +
        benchmarkCustom.targetTotalPatients.toFixed(0) + '人 (' + 
        (benchmarkCustom.patientDiff >= 0 ? '+' : '') + benchmarkCustom.patientDiff.toFixed(0) + '人)</span></div>' +
        '<div class="benchmark-item"><span>必要な平均単価（患者数固定）</span>' +
        '<span style="font-weight:700;color:' + (benchmarkCustom.priceDiff >= 0 ? '#dc2626' : '#059669') + '">¥' +
        benchmarkCustom.targetPrice.toFixed(0) + ' (' + 
        (benchmarkCustom.priceDiff >= 0 ? '+' : '') + '¥' + benchmarkCustom.priceDiff.toFixed(0) + ')</span></div>' +
        '</div>';
    
    document.getElementById(p + '-benchmarkContent').innerHTML = html;
}

// 月次データ削除
function deleteMonthlyData(dept) {
    const key = getMonthKey(dept);
    const label = getMonthLabel(key);
    
    if (!monthlyData[dept][key]) {
        showAlert(label + 'のデータが存在しません。', 'error');
        return;
    }
    
    if (confirm(label + 'のデータを削除しますか？')) {
        delete monthlyData[dept][key];
        const storageKey = dept === 'outpatient' ? 
            'hospitalOutpatientMonthlyData' : 'hospitalInpatientMonthlyData';
        storage.setItem(storageKey, JSON.stringify(monthlyData[dept]));
        
        showAlert(label + 'のデータを削除しました。', 'success');
        updateMonthlyDataList(dept);
        updateComparisonTable(dept);
    }
}

// 全月次データクリア
function clearAllMonthlyData(dept) {
    const keys = Object.keys(monthlyData[dept]);
    if (keys.length === 0) {
        showAlert('削除するデータがありません。', 'error');
        return;
    }
    
    const count = keys.length;
    if (confirm('全ての月次データ（' + count + '件）を削除しますか？この操作は取り消せません。')) {
        monthlyData[dept] = {};
        const storageKey = dept === 'outpatient' ? 
            'hospitalOutpatientMonthlyData' : 'hospitalInpatientMonthlyData';
        storage.setItem(storageKey, JSON.stringify(monthlyData[dept]));
        
        showAlert('全ての月次データを削除しました。', 'success');
        updateMonthlyDataList(dept);
        updateComparisonTable(dept);
    }
}

// 平均値取得（過誤その他対応版）
function loadAverageFromMonthly(dept) {
    const keys = Object.keys(monthlyData[dept]);
    if (keys.length === 0) {
        showAlert('保存されたデータがありません。', 'error');
        return;
    }
    
    const p = dept === 'outpatient' ? 'op' : 'ip';
    let sumInsuranceRevenue = 0, sumNonInsuranceRevenue = 0, sumOtherRevenue = 0;
    let sumVariable = 0, sumFixed = 0;
    let sumDaily = 0, sumMonthly = 0, sumClinic = 0;
    const count = keys.length;
    
    for (let i = 0; i < keys.length; i++) {
        const data = monthlyData[dept][keys[i]];
        sumInsuranceRevenue += data.insuranceRevenue || 0;
        sumNonInsuranceRevenue += data.nonInsuranceRevenue || 0;
        sumOtherRevenue += data.otherRevenue || 0;
        sumVariable += data.variableCost || 0;
        sumFixed += data.fixed || 0;
        sumDaily += data.finalDailyPatients || 0;
        sumMonthly += data.totalPatients || 0;
        sumClinic += data.clinicDays || 0;
    }
    
    document.getElementById(p + '-insuranceRevenue').value = Math.round(sumInsuranceRevenue / count);
    document.getElementById(p + '-nonInsuranceRevenue').value = Math.round(sumNonInsuranceRevenue / count);
    document.getElementById(p + '-otherRevenue').value = Math.round(sumOtherRevenue / count);
    document.getElementById(p + '-variableCost').value = Math.round(sumVariable / count);
    document.getElementById(p + '-fixedCost').value = Math.round(sumFixed / count);
    document.getElementById(p + '-dailyPatients').value = Math.round(sumDaily / count);
    
    const avgClinicDays = Math.round(sumClinic / count);
    if (dept === 'outpatient') {
        document.getElementById(p + '-clinicDays').value = avgClinicDays;
    } else {
        document.getElementById(p + '-clinicDays').value = 
            avgClinicDays > 30 ? '31' : avgClinicDays.toString();
    }
    
    document.getElementById(p + '-insuranceModeTotal').checked = true;
    document.getElementById(p + '-varModeAmount').checked = true;
    document.getElementById(p + '-patientModeDaily').checked = true;
    
    showAlert(count + '件の保存データから平均値を取得しました。', 'success');
    updateRealtime(dept);
}

// 月次データリスト更新
function updateMonthlyDataList(dept) {
    const p = dept === 'outpatient' ? 'op' : 'ip';
    const keys = Object.keys(monthlyData[dept]).sort();
    
    if (keys.length === 0) {
        document.getElementById(p + '-monthlyDataContent').innerHTML = 
            '<div class="muted">保存されたデータがありません。</div>';
        return;
    }
    
    let html = '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:15px">';
    
    for (let i = 0; i < keys.length; i++) {
        const key = keys[i];
        const data = monthlyData[dept][key];
        const label = getMonthLabel(key);
        const date = new Date(data.timestamp).toLocaleDateString('ja-JP');
        
        html += '<div class="month-select-item form-section" style="padding:15px;cursor:pointer" ' +
            'data-action="selectMonth" data-dept="' + dept + '" data-key="' + key + '">' +
            '<div style="font-weight:700;font-size:1.1rem;margin-bottom:10px;color:#1e293b">' + 
            label + '</div>' +
            '<div style="font-size:.9rem;color:#6b7280;margin-bottom:8px">' + date + '</div>' +
            '<div style="font-size:1.2rem;font-weight:700;color:' + 
            (data.operatingProfit >= 0 ? '#059669' : '#dc2626') + '">経常利益: ¥' + 
            data.operatingProfit.toLocaleString() + '</div>' +
            '<div style="font-size:.9rem;color:#475569;margin-top:8px">患者数: ' + 
            data.finalDailyPatients.toFixed(0) + '人/日<br>総売上: ¥' + 
            ((data.totalRevenue || data.revenue) / 1000000).toFixed(1) + 'M</div>' +
            '</div>';
    }
    
    html += '</div>';
    document.getElementById(p + '-monthlyDataContent').innerHTML = html;
}

// 月選択
function selectMonth(dept, key) {
    const p = dept === 'outpatient' ? 'op' : 'ip';
    const parts = key.split('-');
    const year = parts[0];
    const month = parseInt(parts[1]).toString();
    
    document.getElementById(p + '-yearSelect').value = year;
    document.getElementById(p + '-monthSelect').value = month;
    
    showAlert(getMonthLabel(key) + 'を選択しました。', 'success');
}

// 比較表更新
function updateComparisonTable(dept) {
    const p = dept === 'outpatient' ? 'op' : 'ip';
    const keys = Object.keys(monthlyData[dept]).sort();
    
    if (keys.length < 2) {
        document.getElementById(p + '-comparisonTable').innerHTML = 
            '<div class="muted">2ヶ月以上のデータが保存されると比較表が表示されます。</div>';
        return;
    }
    
    let html = '<table style="width:100%;border-collapse:collapse;font-size:.9rem">' +
        '<thead><tr style="background:#f1f5f9;font-weight:700">' +
        '<th style="padding:12px;text-align:left;border:1px solid #e2e8f0;position:sticky;' +
        'left:0;background:#f1f5f9;z-index:2">項目</th>';
    
    for (let i = 0; i < keys.length; i++) {
        html += '<th style="padding:12px;text-align:right;border:1px solid #e2e8f0;min-width:120px">' +
            getMonthLabel(keys[i]) + '</th>';
    }
    
    html += '<th style="padding:12px;text-align:right;border:1px solid #e2e8f0;' +
        'min-width:120px;background:#fef3c7">平均</th></tr></thead><tbody>';
    
    const items = [
        {label: '総売上高', key: 'totalRevenue', format: 'money'},
        {label: '経常利益', key: 'operatingProfit', format: 'money', highlight: true},
        {label: '損益分岐点比率', key: 'breakEvenRate', format: 'percent'},
        {label: '1日患者数', key: 'finalDailyPatients', format: 'decimal', unit: '人'},
        {label: '平均診療単価', key: 'finalAvgPrice', format: 'money'}
    ];
    
    for (let j = 0; j < items.length; j++) {
        const item = items[j];
        const bgColor = item.highlight ? '#fef3c7' : '#fff';
        html += '<tr style="' + (item.highlight ? 'background:#fef3c7' : '') + '">' +
            '<td style="padding:10px;border:1px solid #e2e8f0;font-weight:600;' +
            'position:sticky;left:0;background:' + bgColor + ';z-index:1">' + 
            item.label + '</td>';
        
        let sum = 0;
        let count = 0;
        
        for (let k = 0; k < keys.length; k++) {
            const data = monthlyData[dept][keys[k]];
            let value = data[item.key];
            // 旧データ対応
            if (item.key === 'totalRevenue' && !value) {
                value = data.revenue || 0;
            }
            sum += value;
            count++;
            
            let displayValue = '';
            if (item.format === 'money') {
                displayValue = '¥' + Math.round(value).toLocaleString();
            } else if (item.format === 'percent') {
                displayValue = value.toFixed(1) + '%';
            } else if (item.format === 'decimal') {
                displayValue = value.toFixed(1) + (item.unit || '');
            }
            
            let color = '#1e293b';
            if (item.key === 'operatingProfit') {
                color = value >= 0 ? '#059669' : '#dc2626';
            }
            
            html += '<td style="padding:10px;border:1px solid #e2e8f0;text-align:right;' +
                'color:' + color + ';font-weight:' + (item.highlight ? '700' : '400') + '">' +
                displayValue + '</td>';
        }
        
        const average = count > 0 ? sum / count : 0;
        let avgDisplay = '';
        if (item.format === 'money') {
            avgDisplay = '¥' + Math.round(average).toLocaleString();
        } else if (item.format === 'percent') {
            avgDisplay = average.toFixed(1) + '%';
        } else if (item.format === 'decimal') {
            avgDisplay = average.toFixed(1) + (item.unit || '');
        }
        
        let avgColor = '#1e293b';
        if (item.key === 'operatingProfit') {
            avgColor = average >= 0 ? '#059669' : '#dc2626';
        }
        
        html += '<td style="padding:10px;border:1px solid #e2e8f0;text-align:right;' +
            'color:' + avgColor + ';font-weight:700;background:#fef3c7">' +
            avgDisplay + '</td></tr>';
    }
    
    html += '</tbody></table>';
    document.getElementById(p + '-comparisonTable').innerHTML = html;
}

// 印刷機能
function printReport() {
    window.print();
}

// 月次データエクスポート
async function exportMonthlyData(dept) {
    if (Object.keys(monthlyData[dept]).length === 0) {
        showAlert('エクスポートするデータがありません。', 'error');
        return;
    }
    
    const deptLabel = dept === 'outpatient' ? '外来' : '入院';
    const exportData = {
        version: '2.1',
        department: dept,
        exportDate: new Date().toISOString(),
        data: monthlyData[dept]
    };
    
    const text = JSON.stringify(exportData, null, 2);
    const blob = new Blob([text], {type: 'application/json'});
    const fileName = deptLabel + '月次データ_' + 
        new Date().toISOString().split('T')[0] + '.json';
    
    await triggerDownload({
        fileName: fileName,
        mimeType: 'application/json',
        blob: blob
    });
    
    showAlert('データをエクスポートしました。', 'success');
}

// 月次データインポート
function importMonthlyData(event, dept) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const imported = JSON.parse(e.target.result);
            let importData;
            
            if (imported.version && imported.data) {
                importData = imported.data;
            } else {
                importData = imported;
            }
            
            if (Object.keys(importData).length === 0) {
                showAlert('インポートするデータがありません。', 'error');
                return;
            }
            
            const count = Object.keys(importData).length;
            if (confirm(count + '件のデータをインポートします。既存のデータは上書きされます。よろしいですか？')) {
                Object.assign(monthlyData[dept], importData);
                const storageKey = dept === 'outpatient' ? 
                    'hospitalOutpatientMonthlyData' : 'hospitalInpatientMonthlyData';
                storage.setItem(storageKey, JSON.stringify(monthlyData[dept]));
                
                showAlert(count + '件のデータをインポートしました。', 'success');
                updateMonthlyDataList(dept);
                updateComparisonTable(dept);
            }
        } catch(error) {
            showAlert('ファイルの読み込みに失敗しました。', 'error');
        }
    };
    
    reader.readAsText(file);
    event.target.value = '';
}

// 診療科別機能
function toggleCustomDept(dept) {
    const p = dept === 'outpatient' ? 'op' : 'ip';
    const select = document.getElementById(p + '-deptName');
    const custom = document.getElementById(p + '-customDeptName');
    
    if (select && custom) {
        if (select.value === 'カスタム') {
            custom.style.display = 'block';
        } else {
            custom.style.display = 'none';
        }
    }
}

function updateDepartmentCalc(dept) {
    // 診療科別の自動計算（必要に応じて実装）
}

// 診療科別計算
function calculateDepartment(dept) {
    const p = dept === 'outpatient' ? 'op' : 'ip';
    let deptName = document.getElementById(p + '-deptName').value;
    
    if (deptName === 'カスタム') {
        const customName = document.getElementById(p + '-customDeptName').value.trim();
        deptName = customName || 'カスタム診療科';
    }
    
    const hours = safeParseFloat(document.getElementById(p + '-deptHours').value);
    const price = safeParseFloat(document.getElementById(p + '-deptPrice').value);
    const varModeElement = document.querySelector('input[name="' + p + '-deptVarMode"]:checked');
    
    if (!varModeElement) {
        showAlert('変動費入力方法を選択してください。', 'error');
        return;
    }
    
    const varMode = varModeElement.value;
    const varInput = safeParseFloat(document.getElementById(p + '-deptVariableCost').value);
    const fixedCost = safeParseFloat(document.getElementById(p + '-deptFixedCost').value);
    const doctorCost = safeParseFloat(document.getElementById(p + '-deptDoctorCost').value);
    
    if (hours === 0 || price === 0) {
        showAlert('診療時間と平均単価を入力してください。', 'error');
        return;
    }
    
    const variableCostPerPatient = (varMode === 'rate') ? price * (varInput / 100) : varInput;
    const marginPerPatient = price - variableCostPerPatient;
    const hourlyOverheads = fixedCost + doctorCost;
    const breakEvenPatientsPerHour = marginPerPatient > 0 ? hourlyOverheads / marginPerPatient : 0;
    const totalPatientsNeeded = breakEvenPatientsPerHour * hours;
    
    const html = 
        '<div class="result-item"><span class="result-label">診療科</span>' +
        '<span class="result-value">' + deptName + '</span></div>' +
        '<div class="result-item"><span class="result-label">必要総患者数</span>' +
        '<span class="result-value ' + (totalPatientsNeeded <= 50 ? 'positive' : 'negative') + '">' +
        totalPatientsNeeded.toFixed(1) + '人</span></div>';
    
    document.getElementById(p + '-departmentContent').innerHTML = html;
    document.getElementById(p + '-departmentResults').style.display = 'block';
    
    showAlert(deptName + 'の分析が完了しました。', 'success');
}

// 月次ピッカー機能
function openMonthlyPicker(dept) {
    try {
        currentPickerDept = dept;
        const modal = document.getElementById('monthlyPickerModal');
        const list = document.getElementById('monthlyPickerList');
        const confirmBtn = document.getElementById('monthlyPickerConfirmBtn');
        
        if (!modal || !list || !confirmBtn) {
            showAlert('モーダル要素が見つかりません。', 'error');
            return;
        }
        
        confirmBtn.disabled = true;
        
        const keys = Object.keys(monthlyData[dept]).sort();
        if (keys.length === 0) {
            list.innerHTML = '<div class="muted">保存された月次データがありません。</div>';
        } else {
            let html = '<div role="group" aria-label="保存月一覧">';
            for (let i = 0; i < keys.length; i++) {
                const key = keys[i];
                const label = getMonthLabel(key);
                const data = monthlyData[dept][key];
                html += '<label class="picker-item">' +
                    '<input type="radio" name="monthlyPick" value="' + key + '">' +
                    '<span>' + label + ' (利益: ¥' + 
                    (data.operatingProfit || 0).toLocaleString() + ')</span></label>';
            }
            html += '</div>';
            list.innerHTML = html;
        }
        
        modal.style.display = 'flex';
        
        if (isIOS || isTouchDevice) {
            const scrollY = window.pageYOffset || document.documentElement.scrollTop;
            document.body.style.position = 'fixed';
            document.body.style.width = '100%';
            document.body.style.top = '-' + scrollY + 'px';
            document.body.setAttribute('data-scroll-position', scrollY);
        }
    } catch (error) {
        console.error('モーダル表示エラー:', error);
        showAlert('データ選択画面の表示に失敗しました。', 'error');
    }
}

function closeMonthlyPicker() {
    try {
        const modal = document.getElementById('monthlyPickerModal');
        if (modal) {
            modal.style.display = 'none';
        }
        
        if (isIOS || isTouchDevice) {
            const scrollY = document.body.getAttribute('data-scroll-position');
            document.body.style.position = '';
            document.body.style.width = '';
            document.body.style.top = '';
            if (scrollY) {
                window.scrollTo(0, parseInt(scrollY) || 0);
                document.body.removeAttribute('data-scroll-position');
            }
        }
        
        currentPickerDept = '';
    } catch (error) {
        console.error('モーダル閉じるエラー:', error);
    }
}

function confirmMonthlyPickerLoad() {
    const selected = document.querySelector('input[name="monthlyPick"]:checked');
    if (!selected || !currentPickerDept) return;
    
    const key = selected.value;
    loadMonthlyDataFromKey(currentPickerDept, key);
    closeMonthlyPicker();
}

function loadMonthlyDataFromKey(dept, key) {
    const p = dept === 'outpatient' ? 'op' : 'ip';
    const label = getMonthLabel(key);
    
    if (!monthlyData[dept][key]) {
        showAlert(label + 'のデータが見つかりません。', 'error');
        return;
    }
    
    const data = monthlyData[dept][key];
    
    // 入力値を復元（過誤その他対応版）
    if (data.inputs) {
        const inputs = data.inputs;
        
        document.getElementById(p + '-insuranceRevenue').value = inputs.insuranceRevenue || '';
        document.getElementById(p + '-nonInsuranceRevenue').value = inputs.nonInsuranceRevenue || '0';
        document.getElementById(p + '-otherRevenue').value = inputs.otherRevenue || '0';
        document.getElementById(p + '-variableCost').value = inputs.variableCost || '';
        document.getElementById(p + '-fixedCost').value = inputs.fixedCost || '';
        document.getElementById(p + '-dailyPatients').value = inputs.dailyPatients || '';
        document.getElementById(p + '-monthlyPatients').value = inputs.monthlyPatients || '';
        document.getElementById(p + '-clinicDays').value = inputs.clinicDays || '22';
        
        if (dept === 'outpatient') {
            const customDays = document.getElementById(p + '-customClinicDays');
            if (customDays) {
                customDays.value = inputs.customClinicDays || '';
                customDays.style.display = inputs.clinicDays === 'custom' ? 'block' : 'none';
            }
        }
        
        const insuranceModeRadio = document.querySelector('input[name="' + p + '-insuranceMode"][value="' + (inputs.insuranceMode || 'total') + '"]');
        if (insuranceModeRadio) insuranceModeRadio.checked = true;
        
        const varModeRadio = document.querySelector('input[name="' + p + '-varMode"][value="' + (inputs.varMode || 'amount') + '"]');
        if (varModeRadio) varModeRadio.checked = true;
        
        const patientModeRadio = document.querySelector('input[name="' + p + '-patientMode"][value="' + (inputs.patientMode || 'daily') + '"]');
        if (patientModeRadio) patientModeRadio.checked = true;
        
        const analysisModeRadio = document.querySelector('input[name="' + p + '-analysisMode"][value="' + (inputs.analysisMode || 'include') + '"]');
        if (analysisModeRadio) analysisModeRadio.checked = true;
        
        const otherModeRadio = document.querySelector('input[name="' + p + '-otherMode"][value="' + (inputs.otherMode || 'include') + '"]');
        if (otherModeRadio) otherModeRadio.checked = true;
        
        document.getElementById(p + '-varTargetInsurance').checked = inputs.varTargetInsurance !== false;
        document.getElementById(p + '-varTargetNonInsurance').checked = inputs.varTargetNonInsurance === true;
        document.getElementById(p + '-varTargetOther').checked = inputs.varTargetOther === true;
    }
    
    showAlert(label + 'のデータを読み込みました。', 'success');
    updateRealtime(dept);
    
    const inputBtn = document.querySelector('#' + dept + '-section .tab-button[data-tab="' + p + '-input"]');
    if (inputBtn) {
        switchTab(p + '-input', inputBtn);
    }
}

// イベントリスナー設定（最終版）
document.addEventListener('DOMContentLoaded', function() {
    // タイマー管理
    const timers = {
        input: null,
        update: null
    };
    
    // クリーンアップ関数
    function clearAllTimers() {
        Object.values(timers).forEach(timer => {
            if (timer) clearTimeout(timer);
        });
    }
    
    // 統合されたクリックハンドラー
    document.addEventListener('click', function(e) {
        const target = e.target;
        const actionElement = target.closest('[data-action]');
        const action = target.getAttribute('data-action') || 
                      (actionElement ? actionElement.getAttribute('data-action') : null);
        
        if (!action) {
            // 部門切り替え
            if (target.classList.contains('dept-btn')) {
                e.preventDefault();
                e.stopPropagation();
                const dept = target.getAttribute('data-dept');
                if (dept) switchDepartment(dept, target);
                return;
            }
            
            // タブ切り替え
            if (target.classList.contains('tab-button')) {
                e.preventDefault();
                e.stopPropagation();
                const tabId = target.getAttribute('data-tab');
                if (tabId) switchTab(tabId, target);
                return;
            }
            
            // 感度分析調整
            if (target.classList.contains('sensitivity-btn')) {
                e.preventDefault();
                e.stopPropagation();
                const type = target.getAttribute('data-adjust');
                const dept = target.getAttribute('data-dept');
                const delta = parseInt(target.getAttribute('data-delta'));
                if (type && dept && !isNaN(delta)) {
                    adjustSensitivity(dept, type, delta);
                }
                return;
            }
            
            // 月次データ選択
            const monthSelectItem = target.closest('.month-select-item');
            if (monthSelectItem) {
                const dept = monthSelectItem.getAttribute('data-dept');
                const key = monthSelectItem.getAttribute('data-key');
                if (dept && key) {
                    selectMonth(dept, key);
                }
                return;
            }
            
            return;
        }
        
        e.preventDefault();
        e.stopPropagation();
        
        const deptElement = target.closest('[data-dept]');
        const dept = target.getAttribute('data-dept') || 
                    (deptElement ? deptElement.getAttribute('data-dept') : null);
        
        // アクション実行
        try {
            switch(action) {
                case 'loadAverage':
                    if (dept) loadAverageFromMonthly(dept);
                    break;
                case 'openPicker':
                    if (dept) openMonthlyPicker(dept);
                    break;
                case 'closePicker':
                    closeMonthlyPicker();
                    break;
                case 'confirmPicker':
                    confirmMonthlyPickerLoad();
                    break;
                case 'calculate':
                    if (dept) calculate(dept);
                    break;
                case 'updateResults':
                    if (dept) updateResults(dept);
                    break;
                case 'exportCSV':
                    if (dept) exportToCSV(dept);
                    break;
                case 'print':
                    printReport();
                    break;
                case 'saveMonthly':
                    if (dept) saveMonthlyData(dept);
                    break;
                case 'loadMonthly':
                    if (dept) loadMonthlyData(dept);
                    break;
                case 'deleteMonthly':
                    if (dept) deleteMonthlyData(dept);
                    break;
                case 'exportMonthly':
                    if (dept) exportMonthlyData(dept);
                    break;
                case 'clearMonthly':
                    if (dept) clearAllMonthlyData(dept);
                    break;
                case 'calculateDept':
                    if (dept) calculateDepartment(dept);
                    break;
                case 'selectMonth':
                    const key = target.getAttribute('data-key');
                    if (dept && key) selectMonth(dept, key);
                    break;
            }
        } catch (error) {
            console.error('Action error:', action, error);
            showAlert('処理中にエラーが発生しました。', 'error');
        }
    }, true);
    
    // 入力イベント（デバウンス付き）
    document.addEventListener('input', function(e) {
        const target = e.target;
        
        if (target.hasAttribute('data-realtime')) {
            const dept = target.getAttribute('data-dept');
            if (dept) {
                clearTimeout(timers.input);
                timers.input = setTimeout(() => {
                    updateRealtime(dept);
                }, 300);
            }
        }
        
        if (target.hasAttribute('data-sensitivity')) {
            const dept = target.getAttribute('data-dept');
            if (dept) {
                clearTimeout(timers.update);
                timers.update = setTimeout(() => {
                    updateSensitivity(dept);
                }, 100);
            }
        }
        
        if (target.hasAttribute('data-update')) {
            const updateType = target.getAttribute('data-update');
            const dept = target.getAttribute('data-dept');
            
            if (dept) {
                clearTimeout(timers.update);
                timers.update = setTimeout(() => {
                    switch(updateType) {
                        case 'results':
                            updateResults(dept);
                            break;
                        case 'target':
                            updateTargetAnalysis(dept);
                            break;
                        case 'patient':
                            updatePatientAnalysis(dept);
                            break;
                        case 'benchmark':
                            updateBenchmark(dept);
                            break;
                    }
                }, 500);
            }
        }
        
        if (target.hasAttribute('data-deptcalc')) {
            const dept = target.getAttribute('data-dept');
            if (dept) updateDepartmentCalc(dept);
        }
    });
    
    // 変更イベント
    document.addEventListener('change', function(e) {
        const target = e.target;
        
        // ラジオボタン、チェックボックス、セレクトボックス
        if (target.type === 'radio' || target.type === 'checkbox' || target.type === 'select-one') {
            const dept = target.getAttribute('data-dept');
            if (dept) {
                updateRealtime(dept);
                
                // 診療日数のカスタム表示切り替え
                if (target.id === 'op-clinicDays') {
                    const customDays = document.getElementById('op-customClinicDays');
                    if (customDays) {
                        customDays.style.display = target.value === 'custom' ? 'block' : 'none';
                    }
                }
                
                // 診療科名のカスタム表示切り替え
                if (target.id === 'op-deptName' || target.id === 'ip-deptName') {
                    toggleCustomDept(dept);
                }
            }
        }
        
        // ファイルインポート
        if (target.hasAttribute('data-import')) {
            const dept = target.getAttribute('data-dept');
            if (dept) importMonthlyData(e, dept);
        }
        
        // 月次ピッカーのラジオボタン
        if (target.name === 'monthlyPick') {
            const confirmBtn = document.getElementById('monthlyPickerConfirmBtn');
            if (confirmBtn) {
                confirmBtn.disabled = false;
            }
        }
    });
    
    // モーダル処理
    const modal = document.getElementById('monthlyPickerModal');
    if (modal) {
        modal.addEventListener('click', function(e) {
            if (e.target === this) {
                closeMonthlyPicker();
            }
        });
        
        const modalContent = modal.querySelector('.modal');
        if (modalContent) {
            modalContent.addEventListener('click', function(e) {
                e.stopPropagation();
            });
        }
    }
    
    // visibilitychangeリスナー
    document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
            clearAllTimers();
        } else {
            if (currentDept) {
                updateRealtime(currentDept);
            }
        }
    });
    
    // iOS最適化
    if (isIOS) {
        // パッシブリスナーの使用
        document.addEventListener('touchstart', function() {}, {passive: true});
        
        // 数値入力フィールドの最適化
        const numberInputs = document.querySelectorAll('input[type="number"]');
        numberInputs.forEach(input => {
            input.addEventListener('focus', function() {
                this.setAttribute('pattern', '\\d*');
                if (this.getAttribute('inputmode') !== 'decimal') {
                    this.setAttribute('inputmode', 'numeric');
                }
                
                const rect = this.getBoundingClientRect();
                if (rect.top < 100) {
                    setTimeout(() => {
                        window.scrollTo(0, 0);
                    }, 100);
                }
            });
        });
    }
    
    // ページ離脱時のクリーンアップ
    window.addEventListener('beforeunload', clearAllTimers);
    
    // 初期化処理
    try {
        // 月次データリストを初期表示
        updateMonthlyDataList('outpatient');
        updateRealtime('outpatient');
        
        // 現在の年月を設定
        const now = new Date();
        const currentYear = now.getFullYear();
        const currentMonth = now.getMonth() + 1;
        const fiscalYear = currentMonth >= 4 ? currentYear : currentYear - 1;
        
        const elements = {
            opYear: document.getElementById('op-yearSelect'),
            opMonth: document.getElementById('op-monthSelect'),
            ipYear: document.getElementById('ip-yearSelect'),
            ipMonth: document.getElementById('ip-monthSelect')
        };
        
        if (elements.opYear) elements.opYear.value = fiscalYear;
        if (elements.opMonth) elements.opMonth.value = currentMonth.toString();
        if (elements.ipYear) elements.ipYear.value = fiscalYear;
        if (elements.ipMonth) elements.ipMonth.value = currentMonth.toString();
        
        // デフォルト値の設定
        const defaultValues = {
            'op-targetRate': '100',
            'ip-targetRate': '100',
            'op-customBenchmarkRate': '105',
            'ip-customBenchmarkRate': '105'
        };
        
        Object.keys(defaultValues).forEach(id => {
            const element = document.getElementById(id);
            if (element && !element.value) {
                element.value = defaultValues[id];
            }
        });
        
        console.log('病院経営分析シミュレーター 初期化完了');
        console.log('Version: 2.2.0 (過誤その他対応版)');
        console.log('Device:', isIOS ? 'iOS' : (isTouchDevice ? 'Touch' : 'Desktop'));
        
    } catch (error) {
        console.error('初期化エラー:', error);
        showAlert('初期化中にエラーが発生しました。ページを再読み込みしてください。', 'warning');
    }
});

// ウィンドウリサイズ時の処理
let resizeTimer;
window.addEventListener('resize', function() {
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(function() {
        const width = window.innerWidth;
        const isMobile = width <= 768;
        
        // テーブルのスクロール調整
        const tables = document.querySelectorAll('table');
        tables.forEach(table => {
            const wrapper = table.parentElement;
            if (wrapper && wrapper.style.overflowX) {
                wrapper.scrollLeft = 0;
            }
        });
        
        // モーダルの位置調整
        const modal = document.getElementById('monthlyPickerModal');
        if (modal && modal.style.display === 'flex') {
            const modalContent = modal.querySelector('.modal');
            if (modalContent && isMobile) {
                modalContent.style.maxHeight = '80vh';
            }
        }
    }, 250);
});

// キーボードショートカット
document.addEventListener('keydown', function(e) {
    // Escキーでモーダルを閉じる
    if (e.key === 'Escape') {
        const modal = document.getElementById('monthlyPickerModal');
        if (modal && modal.style.display === 'flex') {
            closeMonthlyPicker();
        }
    }
    
    // Ctrl/Cmd + S で保存
    if ((e.ctrlKey || e.metaKey) && e.key === 's') {
        e.preventDefault();
        const dept = currentDept;
        if (calcData[dept].revenue) {
            saveMonthlyData(dept);
        }
    }
    
    // Ctrl/Cmd + P で印刷
    if ((e.ctrlKey || e.metaKey) && e.key === 'p') {
        e.preventDefault();
        printReport();
    }
});

// エラーハンドリング
window.addEventListener('error', function(e) {
    console.error('Global error:', e.error);
    if (e.error && e.error.message && e.error.message.includes('Critical')) {
        showAlert('システムエラーが発生しました。ページを再読み込みしてください。', 'error');
    }
});

window.addEventListener('unhandledrejection', function(e) {
    console.error('Unhandled promise rejection:', e.reason);
    e.preventDefault();
});

console.log('病院経営分析シミュレーター Ready');
</script>
</body>
</html>